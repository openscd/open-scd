{"version":3,"file":"wizard-host.js","sourceRoot":"","sources":["../../mixins/wizard-host.ts"],"names":[],"mappings":";;AAAA,OAAO,EAAE,SAAS,EAAO,GAAG,EAAE,MAAM,uBAAuB,CAAC;AAC5D,OAAO,EAAE,GAAG,EAAE,IAAI,EAAE,UAAU,EAAkB,MAAM,KAAK,CAAC;AAC5D,OAAO,EACL,aAAa,EACb,YAAY,EACZ,QAAQ,EACR,KAAK,GACN,MAAM,mBAAmB,CAAC;AAC3B,OAAO,EAAE,IAAI,IAAI,UAAU,EAAE,YAAY,EAAE,MAAM,oBAAoB,CAAC;AACtE,OAAO,EAAE,MAAM,EAAE,MAAM,sBAAsB,CAAC;AAE9C,OAAO,EAAU,SAAS,EAAE,MAAM,eAAe,CAAC;AAElD,OAAO,sBAAsB,CAAC;AAC9B,OAAO,uBAAuB,CAAC;AAkB/B,SAAS,gBAAgB,CAAC,CAA4B;IACpD,IAAI,CAAC,CAAC,EAAE;QACN,OAAO,KAAK,CAAC;KACd;IACD,OAAO,OAAO,CAAE,CAAiB,CAAC,UAAU,IAAK,CAAiB,CAAC,SAAS,CAAC,CAAC;AAChF,CAAC;AAED,MAAM,QAAQ,GAAG,kBAAkB,CAAC;AAGpC,IAAa,UAAU,kBAAvB,MAAa,UAAW,SAAQ,UAAU;IAA1C;;QAES,YAAO,GAAc,EAAE,CAAC;QAMvB,sBAAiB,GAAmB,EAAE,CAAC;QAGvC,kBAAa,GAAa,EAAE,CAAC;QAG7B,0BAAqB,GAAqB,EAAE,CAAC;QAE7C,cAAS,GAAqB,SAAS,EAAE,CAAC;QA8PlD,8BAA8B;QAEvB,SAAI,GAAY,OAAO,CAAC;IAyBjC,CAAC;IAvRC,MAAM;QACJ,OAAO,IAAI,CAAA;;wCAEyB,IAAI,CAAC,2BAA2B;0CAC9B,IAAI,CAAC,6BAA6B;;;QAGpE,IAAI,CAAC,mBAAmB,EAAE;KAC7B,CAAC;IACJ,CAAC;IAEO,mBAAmB;QACzB,IACE,IAAI,CAAC,aAAa,CAAC,MAAM,KAAK,CAAC;YAC/B,IAAI,CAAC,qBAAqB,CAAC,MAAM,KAAK,CAAC;YACvC,IAAI,CAAC,aAAa,CAAC,MAAM,KAAK,IAAI,CAAC,qBAAqB,CAAC,MAAM,EAC/D;YACA,OAAO,IAAI,CAAA,EAAE,CAAC;SACf;QAED,OAAO,IAAI,CAAA;;;iBAGE,IAAI,CAAC,mBAAmB;oBACrB,GAAG,EAAE,GAAE,CAAC;gCACI,IAAI,CAAC,oBAAoB;;UAE/C,IAAI,CAAC,aAAa,CAAC,GAAG,CAAC,CAAC,MAAM,EAAE,CAAC,EAAE,EAAE;YACrC,MAAM,UAAU,GAAG,IAAI,CAAC,aAAa,CAAC,MAAM,GAAG,CAAC,GAAG,CAAC,CAAC;YACrD,OAAO,YAAU,CAAC,mBAAmB,CACnC,MAAM,EACN,IAAI,CAAC,qBAAqB,CAAC,CAAC,CAAC,EAC7B,UAAU,CACX,CAAC;QACJ,CAAC,CAAC;;KAEL,CAAC;IACJ,CAAC;IAEO,MAAM,CAAC,mBAAmB,CAChC,MAAe,EACf,WAA4B,EAC5B,UAAU,GAAG,CAAC;QAEd,IAAI,CAAC,MAAM,IAAI,CAAC,WAAW,EAAE;YAC3B,OAAO,IAAI,CAAA,EAAE,CAAC;SACf;QAED,MAAM,OAAO,GAAG,SAAS,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC;QAEtC,MAAM,KAAK,GAAG;YACZ,UAAU,EAAE,WAAW,CAAC,OAAO;YAC/B,UAAU,EAAE,WAAW,CAAC,OAAO;YAC/B,SAAS,EAAE,WAAW,CAAC,MAAM;SAC9B,CAAC;QAEF,MAAM,cAAc,GAAG,UAAU,CAAA,IAAI,YAAY,CAAC,OAAO,CAAC,IAAI,MAAM,CAClE,KAAK,CACN,MAAM,YAAY,CAAC,OAAO,CAAC,GAAG,CAAC;QAEhC,OAAO,IAAI,CAAA;8BACe,UAAU,KAAK,cAAc;KACtD,CAAC;IACJ,CAAC;IAEO,kBAAkB,CACxB,MAAe,EACf,WAA4B;QAE5B,IAAI,CAAC,MAAM,IAAI,CAAC,WAAW,EAAE;YAC3B,OAAO,IAAI,CAAA,EAAE,CAAC;SACf;QAED,MAAM,OAAO,GAAG,SAAS,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC;QAEtC,MAAM,KAAK,GAAG;YACZ,UAAU,EAAE,WAAW,CAAC,OAAO;YAC/B,UAAU,EAAE,WAAW,CAAC,OAAO;YAC/B,SAAS,EAAE,WAAW,CAAC,MAAM;SAC9B,CAAC;QAEF,MAAM,cAAc,GAAG,UAAU,CAAA,IAAI,YAAY,CAAC,OAAO,CAAC,IAAI,MAAM,CAClE,KAAK,CACN,MAAM,YAAY,CAAC,OAAO,CAAC,GAAG,CAAC;QAEhC,8CAA8C;QAC9C,uCAAuC;QACvC,OAAO,IAAI,CAAA;;;iBAGE,IAAI,CAAC,mBAAmB;oBACrB,GAAG,EAAE,GAAE,CAAC;gCACI,IAAI,CAAC,oBAAoB;;;YAG7C,GAAG,CAAC,IAAI,CAAC,SAAS,CAAC;;;;;;iBAMd,cAAc;;;KAG1B,CAAC;IACJ,CAAC;IAGO,mBAAmB,CAAC,CAAe;QACzC,MAAM,mBAAmB,GAAG,IAAI,CAAC,SAAS,CAAC,KAAK,KAAK,CAAC,CAAC,MAAM,CAAC;QAC9D,IAAI,CAAC,mBAAmB,EAAE;YACxB,OAAO;SACR;QAED,IAAI,CAAC,oBAAoB,EAAE,CAAC;IAC9B,CAAC;IAEO,2BAA2B,CAAC,CAAqC;;QACvE,MAAM,OAAO,GAAG,CAAC,CAAC,MAAM,CAAC,OAAiB,CAAC;QAE3C,OAAO,CAAC,GAAG,CAAC,EAAE,KAAK,EAAE,KAAK,EAAE,GAAG,EAAE,oBAAoB,EAAE,CAAC,EAAE,CAAC,CAAC;QAE5D,MAAM,gBAAgB,GAAG,MAAA,IAAI,CAAC,OAAO,0CAAE,MAAM,CAAC,CAAC,CAAC,EAAE,CAChD,YAAU,CAAC,yBAAyB,CAAC,OAAO,EAAE,CAAC,CAAC,CACjD,CAAC;QAEF,IAAI,CAAA,gBAAgB,aAAhB,gBAAgB,uBAAhB,gBAAgB,CAAE,MAAM,MAAK,CAAC,EAAE;YAClC,OAAO,CAAC,IAAI,CAAC;gBACX,KAAK,EAAE,MAAM;gBACb,GAAG,EAAE,6CAA6C;gBAClD,OAAO;aACR,CAAC,CAAC;YACH,OAAO;SACR;QACD,MAAM,eAAe,GAAG,gBAAgB,aAAhB,gBAAgB,uBAAhB,gBAAgB,CAAG,gBAAgB,CAAC,MAAM,GAAG,CAAC,CAAC,CAAC;QAExE,IAAI,CAAC,eAAe,EAAE;YACpB,OAAO,CAAC,IAAI,CAAC;gBACX,KAAK,EAAE,MAAM;gBACb,GAAG,EAAE,0CAA0C;gBAC/C,OAAO;aACR,CAAC,CAAC;YACH,OAAO;SACR;QACD,0CAA0C;QAC1C,IAAI,CAAC,iBAAiB,GAAG,CAAC,CAAC,MAAM,CAAC;QAClC,IAAI,CAAC,YAAY,GAAG,eAAe,CAAC;QAEpC,IAAI,CAAC,aAAa,CAAC,IAAI,CAAC,eAAe,CAAC,CAAC;QACzC,IAAI,CAAC,qBAAqB,CAAC,IAAI,CAAC,CAAC,CAAC,MAAM,CAAC,CAAC;IAC5C,CAAC;IAEO,6BAA6B,CACnC,CAAuC;;QAEvC,MAAM,EAAE,GAAG,CAAC,CAAC,MAAM,CAAC,OAAO,CAAC;QAE5B,MAAM,EAAE,OAAO,EAAE,GAAG,EAAE,CAAC;QACvB,MAAM,gBAAgB,GAAG,MAAA,IAAI,CAAC,OAAO,0CAAE,MAAM,CAAC,CAAC,CAAC,EAAE,CAChD,YAAU,CAAC,2BAA2B,CAAC,OAAO,EAAE,CAAC,CAAC,CACnD,CAAC;QAEF,IAAI,CAAA,gBAAgB,aAAhB,gBAAgB,uBAAhB,gBAAgB,CAAE,MAAM,MAAK,CAAC,EAAE;YAClC,OAAO,CAAC,IAAI,CAAC;gBACX,KAAK,EAAE,MAAM;gBACb,GAAG,EAAE,+CAA+C;gBACpD,OAAO;aACR,CAAC,CAAC;YACH,OAAO;SACR;QAED,MAAM,eAAe,GAAG,gBAAgB,aAAhB,gBAAgB,uBAAhB,gBAAgB,CAAG,gBAAgB,CAAC,MAAM,GAAG,CAAC,CAAC,CAAC;QAExE,IAAI,CAAC,eAAe,EAAE;YACpB,OAAO,CAAC,IAAI,CAAC;gBACX,KAAK,EAAE,MAAM;gBACb,GAAG,EAAE,0CAA0C;gBAC/C,OAAO;aACR,CAAC,CAAC;YACH,OAAO;SACR;QAED,0CAA0C;QAC1C,IAAI,CAAC,iBAAiB,GAAG,CAAC,CAAC,MAAM,CAAC;QAClC,IAAI,CAAC,YAAY,GAAG,eAAe,CAAC;QAEpC,IAAI,CAAC,aAAa,CAAC,IAAI,CAAC,eAAe,CAAC,CAAC;QACzC,IAAI,CAAC,qBAAqB,CAAC,IAAI,CAAC,CAAC,CAAC,MAAM,CAAC,CAAC;IAC5C,CAAC;IAEO,oBAAoB;QAC1B,IAAI,CAAC,aAAa,CAAC,GAAG,EAAE,CAAC;QACzB,IAAI,CAAC,qBAAqB,CAAC,GAAG,EAAE,CAAC;QACjC,IAAI,CAAC,aAAa,EAAE,CAAC;QACrB,iCAAiC;IACnC,CAAC;IAEO,MAAM,CAAC,2BAA2B,CACxC,OAAe,EACf,MAAc;QAEd,MAAM,WAAW,GAAG,YAAU,CAAC,kBAAkB,CAAC,MAAM,CAAC,CAAC;QAC1D,IAAI,CAAC,WAAW,EAAE;YAChB,OAAO,KAAK,CAAC;SACd;QAED,MAAM,kBAAkB,GAAG,WAAW,aAAX,WAAW,uBAAX,WAAW,CAAE,UAAU,CAAE,OAAO,CAAC,CAAC;QAE7D,OAAO,kBAAkB,CAAC;IAC5B,CAAC;IAEO,MAAM,CAAC,yBAAyB,CACtC,OAAe,EACf,MAAc;QAEd,MAAM,WAAW,GAAG,YAAU,CAAC,kBAAkB,CAAC,MAAM,CAAC,CAAC;QAC1D,IAAI,CAAC,WAAW,EAAE;YAChB,OAAO,KAAK,CAAC;SACd;QAED,MAAM,gBAAgB,GAAG,WAAW,aAAX,WAAW,uBAAX,WAAW,CAAE,SAAS,CAAE,OAAO,CAAC,CAAC;QAE1D,OAAO,gBAAgB,CAAC;IAC1B,CAAC;IAEO,MAAM,CAAC,kBAAkB,CAAC,MAAc;QAC9C,MAAM,SAAS,GAAG,SAAS,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC;QACxC,MAAM,WAAW,GAAG,cAAc,CAAC,GAAG,CAAC,SAAS,CAAC,CAAC;QAClD,IAAI,CAAC,WAAW,EAAE;YAChB,OAAO,CAAC,GAAG,CAAC;gBACV,KAAK,EAAE,MAAM;gBACb,GAAG,EAAE,kBAAkB;gBACvB,SAAS;gBACT,GAAG,EAAE,MAAM,CAAC,GAAG;aAChB,CAAC,CAAC;YACH,OAAO,SAAS,CAAC;SAClB;QAED,IAAI,CAAC,gBAAgB,CAAC,WAAW,CAAC,EAAE;YAClC,OAAO,CAAC,GAAG,CAAC;gBACV,KAAK,EAAE,MAAM;gBACb,GAAG,EAAE,iCAAiC;gBACtC,WAAW;gBACX,SAAS;gBACT,GAAG,EAAE,MAAM,CAAC,GAAG;aAChB,CAAC,CAAC;YACH,OAAO,SAAS,CAAC;SAClB;QAED,OAAO,WAAW,CAAC;IACrB,CAAC;CA6BF,CAAA;AAvBQ,iBAAM,GAAG,GAAG,CAAA;;;;;;;;;;;;;;;;;;;;;;GAsBlB,CAAC;AAtSF;IADC,QAAQ,CAAC,EAAE,IAAI,EAAE,KAAK,EAAE,CAAC;2CACK;AAG/B;IADC,KAAK,EAAE;gDACsB;AAG9B;IADC,KAAK,EAAE;qDACuC;AAG/C;IADC,KAAK,EAAE;iDAC6B;AAGrC;IADC,KAAK,EAAE;yDAC6C;AAgHrD;IADC,YAAY,CAAC,EAAE,OAAO,EAAE,IAAI,EAAE,CAAC;qDAQ/B;AA2ID;IADC,QAAQ,EAAE;wCACoB;AAhRpB,UAAU;IADtB,aAAa,CAAC,QAAQ,CAAC;GACX,UAAU,CAyStB;SAzSY,UAAU","sourcesContent":["import { createRef, Ref, ref } from 'lit/directives/ref.js';\nimport { css, html, LitElement, TemplateResult } from 'lit';\nimport {\n  customElement,\n  eventOptions,\n  property,\n  state,\n} from 'lit/decorators.js';\nimport { html as staticHtml, unsafeStatic } from 'lit/static-html.js';\nimport { spread } from '@open-wc/lit-helpers';\n\nimport { Plugin, pluginTag } from './Plugging.js';\n\nimport '@material/mwc-dialog';\nimport '../components/card.js';\n\ntype WizardClass = CustomElementConstructor & {\n  canInspect: (tagName: string) => boolean;\n  canCreate: (tagName: string) => boolean;\n};\n\ntype WizardInspectionRequest = {\n  element: Element;\n};\n\ntype WizardCreationRequest = {\n  parent: Element;\n  tagName?: string;\n};\n\ntype WizardAllProps = Partial<WizardInspectionRequest & WizardCreationRequest>;\n\nfunction isWizardingClass(c?: CustomElementConstructor): c is WizardClass {\n  if (!c) {\n    return false;\n  }\n  return Boolean((c as WizardClass).canInspect && (c as WizardClass).canCreate);\n}\n\nconst TAG_NAME = 'oscd-wizard-host';\n\n@customElement(TAG_NAME)\nexport class WizardHost extends LitElement {\n  @property({ type: Array })\n  public wizards?: Plugin[] = [];\n\n  @state()\n  private activeWizard?: Plugin;\n\n  @state()\n  private activeWizardProps: WizardAllProps = {};\n\n  @state()\n  private activeWizards: Plugin[] = [];\n\n  @state()\n  private activeWizardPropsList: WizardAllProps[] = [];\n\n  private dialogRef: Ref<HTMLElement> = createRef();\n\n  render() {\n    return html`\n      <slot\n        @oscd-wizard-creation-request=${this.handleWizardCreationRequest}\n        @oscd-wizard-inspection-request=${this.handleWizardInspectionRequest}\n      ></slot>\n\n      ${this.renderActiveWizards()}\n    `;\n  }\n\n  private renderActiveWizards(): TemplateResult {\n    if (\n      this.activeWizards.length === 0 ||\n      this.activeWizardPropsList.length === 0 ||\n      this.activeWizards.length !== this.activeWizardPropsList.length\n    ) {\n      return html``;\n    }\n\n    return html`\n      <dialog\n        open\n        @click=${this.handleBackdropClick}\n        @keypress=${() => {}}\n        @oscd-wizard-finished=${this.handleWizardFinished}\n      >\n        ${this.activeWizards.map((wizard, i) => {\n          const stackLevel = this.activeWizards.length - i - 1;\n          return WizardHost.renderActiveWizard2(\n            wizard,\n            this.activeWizardPropsList[i],\n            stackLevel\n          );\n        })}\n      </dialog>\n    `;\n  }\n\n  private static renderActiveWizard2(\n    wizard?: Plugin,\n    wizardProps?: WizardAllProps,\n    stackLevel = 0\n  ): TemplateResult {\n    if (!wizard || !wizardProps) {\n      return html``;\n    }\n\n    const tagName = pluginTag(wizard.src);\n\n    const props = {\n      '.element': wizardProps.element,\n      '.tagName': wizardProps.tagName,\n      '.parent': wizardProps.parent,\n    };\n\n    const renderedWizard = staticHtml`<${unsafeStatic(tagName)} ${spread(\n      props\n    )}></${unsafeStatic(tagName)}>`;\n\n    return html`\n      <oscd-card stackLevel=${stackLevel}> ${renderedWizard} </oscd-card>\n    `;\n  }\n\n  private renderActiveWizard(\n    wizard?: Plugin,\n    wizardProps?: WizardAllProps\n  ): TemplateResult {\n    if (!wizard || !wizardProps) {\n      return html``;\n    }\n\n    const tagName = pluginTag(wizard.src);\n\n    const props = {\n      '.element': wizardProps.element,\n      '.tagName': wizardProps.tagName,\n      '.parent': wizardProps.parent,\n    };\n\n    const renderedWizard = staticHtml`<${unsafeStatic(tagName)} ${spread(\n      props\n    )}></${unsafeStatic(tagName)}>`;\n\n    // we use mwc-dialog to get the \"card\" visual,\n    // because there is no component for it\n    return html`\n      <dialog\n        open\n        @click=${this.handleBackdropClick}\n        @keypress=${() => {}}\n        @oscd-wizard-finished=${this.handleWizardFinished}\n      >\n        <mwc-dialog\n          ${ref(this.dialogRef)}\n          open\n          scrimClickAction=\"\"\n          hideActions\n          class=\"no-bg\"\n        >\n          <div>${renderedWizard}</div>\n        </mwc-dialog>\n      </dialog>\n    `;\n  }\n\n  @eventOptions({ capture: true })\n  private handleBackdropClick(e: PointerEvent) {\n    const isTargetTheBackdrop = this.dialogRef.value === e.target;\n    if (!isTargetTheBackdrop) {\n      return;\n    }\n\n    this.handleWizardFinished();\n  }\n\n  private handleWizardCreationRequest(e: CustomEvent<WizardCreationRequest>) {\n    const tagName = e.detail.tagName as string;\n\n    console.log({ level: 'dev', msg: 'wizarding creation', e });\n\n    const availableWizards = this.wizards?.filter(w =>\n      WizardHost.doesWizardSupportCreation(tagName, w)\n    );\n\n    if (availableWizards?.length === 0) {\n      console.warn({\n        level: 'warn',\n        msg: 'no wizards available for creation, stopping',\n        tagName,\n      });\n      return;\n    }\n    const newActiveWizard = availableWizards?.[availableWizards.length - 1];\n\n    if (!newActiveWizard) {\n      console.warn({\n        level: 'warn',\n        msg: 'could not retrieve last wizard, stopping',\n        tagName,\n      });\n      return;\n    }\n    // might need to set them at the same time\n    this.activeWizardProps = e.detail;\n    this.activeWizard = newActiveWizard;\n\n    this.activeWizards.push(newActiveWizard);\n    this.activeWizardPropsList.push(e.detail);\n  }\n\n  private handleWizardInspectionRequest(\n    e: CustomEvent<WizardInspectionRequest>\n  ) {\n    const el = e.detail.element;\n\n    const { tagName } = el;\n    const availableWizards = this.wizards?.filter(w =>\n      WizardHost.doesWizardSupportInspection(tagName, w)\n    );\n\n    if (availableWizards?.length === 0) {\n      console.warn({\n        level: 'warn',\n        msg: 'no wizards available for inspection, stopping',\n        tagName,\n      });\n      return;\n    }\n\n    const newActiveWizard = availableWizards?.[availableWizards.length - 1];\n\n    if (!newActiveWizard) {\n      console.warn({\n        level: 'warn',\n        msg: 'could not retrieve last wizard, stopping',\n        tagName,\n      });\n      return;\n    }\n\n    // might need to set them at the same time\n    this.activeWizardProps = e.detail;\n    this.activeWizard = newActiveWizard;\n\n    this.activeWizards.push(newActiveWizard);\n    this.activeWizardPropsList.push(e.detail);\n  }\n\n  private handleWizardFinished() {\n    this.activeWizards.pop();\n    this.activeWizardPropsList.pop();\n    this.requestUpdate();\n    // this.activeWizard = undefined;\n  }\n\n  private static doesWizardSupportInspection(\n    tagName: string,\n    wizard: Plugin\n  ): boolean {\n    const wizardClass = WizardHost.extractWizardClass(wizard);\n    if (!wizardClass) {\n      return false;\n    }\n\n    const supportsInspection = wizardClass?.canInspect!(tagName);\n\n    return supportsInspection;\n  }\n\n  private static doesWizardSupportCreation(\n    tagName: string,\n    wizard: Plugin\n  ): boolean {\n    const wizardClass = WizardHost.extractWizardClass(wizard);\n    if (!wizardClass) {\n      return false;\n    }\n\n    const supportsCreation = wizardClass?.canCreate!(tagName);\n\n    return supportsCreation;\n  }\n\n  private static extractWizardClass(wizard: Plugin): WizardClass | undefined {\n    const wizardTag = pluginTag(wizard.src);\n    const wizardClass = customElements.get(wizardTag);\n    if (!wizardClass) {\n      console.log({\n        level: 'warn',\n        msg: 'wizard not found',\n        wizardTag,\n        src: wizard.src,\n      });\n      return undefined;\n    }\n\n    if (!isWizardingClass(wizardClass)) {\n      console.log({\n        level: 'warn',\n        msg: 'wizard is not a wizarding class',\n        wizardClass,\n        wizardTag,\n        src: wizard.src,\n      });\n      return undefined;\n    }\n\n    return wizardClass;\n  }\n\n  // Declare reactive properties\n  @property()\n  public name?: string = 'World';\n\n  static styles = css`\n    :host {\n      color: blue;\n    }\n\n    dialog {\n      position: fixed;\n      height: 100%;\n      width: 100%;\n      top: 0;\n      left: 0;\n      background: #0000004a;\n      z-index: 1000;\n      opacity: 1;\n      backdrop-filter: blur(2px);\n      outline: none;\n      border: none;\n    }\n\n    .no-bg {\n      --mdc-dialog-scrim-color: none;\n    }\n  `;\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    [TAG_NAME]: WizardHost;\n  }\n}\n"]}