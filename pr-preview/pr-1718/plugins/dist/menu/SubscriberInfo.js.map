{"version":3,"file":"SubscriberInfo.js","sourceRoot":"","sources":["../../src/menu/SubscriberInfo.ts"],"names":[],"mappings":"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","sourcesContent":["import { LitElement } from 'lit-element';\nimport { get } from 'lit-translate';\nimport { getVersion } from '@openscd/open-scd/src/foundation.js';\n\nimport { createElement } from '@openscd/xml';\n\nimport {\n  newActionEvent,\n  SimpleAction,\n} from '@openscd/core/foundation/deprecated/editor.js';\n\nfunction getElementIndexOf(list: (Element | null)[], match: Element): number {\n  for (let i = 0; list.length; i++) if (list[i]?.isEqualNode(match)) return i;\n\n  return -1;\n}\n\nfunction addIEDName(extRef: Element, gseControl: Element): Element | null {\n  const [ied, accPoint, lDevice, ln, ln0] = [\n    'IED',\n    'AccessPoint',\n    'LDevice',\n    'LN',\n    'LN0',\n  ].map(element => extRef.closest(element));\n  const anyln = ln ? ln : ln0;\n\n  if (\n    getVersion(extRef) === '2007' &&\n    Array.from(gseControl.getElementsByTagName('IEDName'))\n      .filter(item => !item.closest('Private'))\n      .filter(\n        iedName =>\n          iedName.innerHTML === ied?.getAttribute('name') &&\n          (iedName.getAttribute('apRef') ?? '') ===\n            (accPoint?.getAttribute('name') ?? '') &&\n          (iedName.getAttribute('ldInst') ?? '') ===\n            (lDevice?.getAttribute('inst') ?? '') &&\n          (iedName.getAttribute('prefix') ?? '') ===\n            (anyln?.getAttribute('prefix') ?? '') &&\n          (iedName.getAttribute('lnClass') ?? '') ===\n            (anyln?.getAttribute('lnClass') ?? '') &&\n          (iedName.getAttribute('lnInst') ?? '') ===\n            (anyln?.getAttribute('inst') ?? '')\n      ).length === 0\n  ) {\n    const iedName: Element = createElement(\n      gseControl.ownerDocument,\n      'IEDName',\n      {\n        apRef: accPoint?.getAttribute('name') ?? '',\n        ldInst: lDevice?.getAttribute('inst') ?? '',\n        prefix: anyln?.getAttribute('prefix') ?? '',\n        lnClass: anyln?.getAttribute('lnClass') ?? '',\n        lnInst: anyln?.getAttribute('inst') || null,\n      }\n    );\n    iedName.innerHTML = ied?.getAttribute('name')!;\n\n    return iedName;\n  }\n\n  if (\n    Array.from(gseControl.getElementsByTagName('IEDName'))\n      .filter(item => !item.closest('Private'))\n      .filter(iedName => iedName.innerHTML === ied?.getAttribute('name'))\n      .length === 0\n  ) {\n    const iedName: Element = createElement(\n      gseControl.ownerDocument,\n      'IEDName',\n      {}\n    );\n    iedName.innerHTML = ied?.getAttribute('name')!;\n\n    return iedName;\n  }\n\n  return null;\n}\n\nfunction getDestination(data: Element, doc: Document): Element[] {\n  return Array.from(doc.getElementsByTagName('ExtRef'))\n    .filter(item => !item.closest('Private'))\n    .filter(\n      extRef =>\n        (extRef.getAttribute('iedName') ?? '') ===\n          (data.closest('IED')?.getAttribute('name') ?? '') &&\n        (extRef.getAttribute('ldInst') ?? '') ===\n          (data.getAttribute('ldInst') ?? '') &&\n        (extRef.getAttribute('prefix') ?? '') ===\n          (data.getAttribute('prefix') ?? '') &&\n        (extRef.getAttribute('lnClass') ?? '') ===\n          (data.getAttribute('lnClass') ?? '') &&\n        (extRef.getAttribute('lnInst') ?? '') ===\n          (data.getAttribute('lnInst') ?? '') &&\n        (extRef.getAttribute('doName') ?? '') ===\n          (data.getAttribute('doName') ?? '') &&\n        (extRef.getAttribute('daName') ?? '') ===\n          (data.getAttribute('daName') ?? '')\n    );\n}\n\nexport function createMissingIEDNameSubscriberInfo(\n  doc: Document\n): SimpleAction[] {\n  const controlList = Array.from(\n    doc.querySelectorAll(\n      ':root > IED > AccessPoint > Server > LDevice > LN0 > GSEControl,' +\n        ':root > IED > AccessPoint > Server > LDevice > LN0 > SampledValueControl'\n    )\n  );\n\n  const simpleAction: SimpleAction[] = [];\n  controlList.forEach(controlBlock => {\n    if (!controlBlock.getAttribute('datSet') || !controlBlock.parentElement)\n      return simpleAction;\n\n    const ln0: Element = controlBlock.parentElement;\n    const dataList: Element[] = Array.from(\n      ln0.querySelectorAll(\n        `:root >  IED > AccessPoint > Server > LDevice > LN0 > DataSet[name=\"${controlBlock.getAttribute(\n          'datSet'\n        )}\"] > FCDA`\n      )\n    );\n\n    const destList: Element[] = dataList\n      .flatMap(data => getDestination(data, doc))\n      .filter(dest => dest !== null)\n      .filter((v, i, a) => a.indexOf(v) === i);\n\n    const iedNameList: (Element | null)[] = destList\n      .map(dest => addIEDName(dest, controlBlock))\n      .filter(iedName => iedName !== null)\n      .filter((v, i, a) => getElementIndexOf(a, v!) === i);\n\n    iedNameList.forEach(iedName => {\n      simpleAction.push({\n        new: {\n          parent: controlBlock,\n          element: iedName!,\n        },\n      });\n    });\n  });\n\n  return simpleAction;\n}\n\nexport default class SubscriberInfoPlugin extends LitElement {\n  doc!: XMLDocument;\n\n  async run(): Promise<void> {\n    const actions: SimpleAction[] = createMissingIEDNameSubscriberInfo(\n      this.doc!\n    );\n\n    if (!actions.length)\n      throw new Error(\n        get('subscriber.description') + get('subscriber.nonewitems')\n      );\n\n    this.dispatchEvent(\n      newActionEvent({\n        title:\n          get('subscriber.description') +\n          get('subscriber.message', {\n            updatenumber: actions.length,\n          }),\n        actions: actions,\n      })\n    );\n\n    return;\n  }\n}\n"]}