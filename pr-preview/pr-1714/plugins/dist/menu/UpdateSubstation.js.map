{"version":3,"file":"UpdateSubstation.js","sourceRoot":"","sources":["../../src/menu/UpdateSubstation.ts"],"names":[],"mappings":";AAAA,OAAO,EAAE,GAAG,EAAE,IAAI,EAAE,UAAU,EAAE,KAAK,EAAkB,MAAM,aAAa,CAAC;AAC3E,OAAO,EAAE,GAAG,EAAE,MAAM,eAAe,CAAC;AAEpC,OAAO,EACL,YAAY,EACZ,IAAI,EACJ,QAAQ,EACR,cAAc,EAEd,IAAI,GACL,MAAM,qCAAqC,CAAC;AAC7C,OAAO,EAAQ,WAAW,EAAE,MAAM,kCAAkC,CAAC;AAErE,MAAM,UAAU,gBAAgB,CAC9B,GAAgB,EAChB,QAAyB;IAEzB,IAAI,OAAO,QAAQ,KAAK,QAAQ;QAAE,OAAO,KAAK,CAAC;IAC/C,MAAM,CAAC,OAAO,EAAE,MAAM,EAAE,MAAM,EAAE,OAAO,EAAE,MAAM,CAAC,GAAG,QAAQ,CAAC,KAAK,CAAC,MAAM,CAAC,CAAC;IAE1E,IAAI,CAAC,OAAO,IAAI,CAAC,OAAO;QAAE,OAAO,KAAK,CAAC;IAEvC,IAAI,MAAM,KAAK,UAAU,EAAE;QACzB,MAAM,CACJ,gBAAgB,EAChB,eAAe,EACf,gBAAgB,EAChB,eAAe,EAChB,GAAG;YACF,CAAC,aAAa,OAAO,IAAI,CAAC;YAC1B,MAAM,CAAC,CAAC,CAAC,CAAC,YAAY,MAAM,IAAI,CAAC,CAAC,CAAC,CAAC,CAAC,gBAAgB,EAAE,aAAa,CAAC;YACrE,CAAC,eAAe,OAAO,IAAI,CAAC;YAC5B,MAAM,CAAC,CAAC,CAAC,CAAC,UAAU,MAAM,IAAI,CAAC,CAAC,CAAC,CAAC,CAAC,cAAc,EAAE,WAAW,CAAC;SAChE,CAAC;QAEF,OAAO,CACL,GAAG,CAAC,aAAa,CACf,YAAY,CACV,gBAAgB,EAChB,CAAC,eAAe,CAAC,EACjB,gBAAgB,EAChB,eAAe,EACf,eAAe,CAChB;aACE,GAAG,CAAC,OAAO,CAAC,EAAE,CAAC,OAAO,CAAC,IAAI,CAAC,EAAE,CAAC,CAAC;aAChC,IAAI,CAAC,GAAG,CAAC,CACb,KAAK,IAAI,CACX,CAAC;KACH;IAED,MAAM,CACJ,gBAAgB,EAChB,eAAe,EACf,eAAe,EACf,gBAAgB,EAChB,eAAe,EAChB,GAAG;QACF,CAAC,aAAa,OAAO,IAAI,CAAC;QAC1B,CAAC,iBAAiB,MAAM,IAAI,CAAC;QAC7B,MAAM,CAAC,CAAC,CAAC,CAAC,YAAY,MAAM,IAAI,CAAC,CAAC,CAAC,CAAC,CAAC,gBAAgB,EAAE,aAAa,CAAC;QACrE,OAAO,KAAK,MAAM,CAAC,CAAC,CAAC,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC,CAAC,eAAe,OAAO,IAAI,CAAC;QAC3D,MAAM,CAAC,CAAC,CAAC,CAAC,UAAU,MAAM,IAAI,CAAC,CAAC,CAAC,CAAC,CAAC,cAAc,EAAE,WAAW,CAAC;KAChE,CAAC;IAEF,OAAO,CACL,GAAG,CAAC,aAAa,CACf,YAAY,CACV,gBAAgB,EAChB,CAAC,GAAG,CAAC,EACL,eAAe,EACf,CAAC,GAAG,CAAC,EACL,gBAAgB,EAChB,eAAe,EACf,eAAe,CAChB;SACE,GAAG,CAAC,OAAO,CAAC,EAAE,CAAC,OAAO,CAAC,IAAI,CAAC,EAAE,CAAC,CAAC;SAChC,IAAI,CAAC,GAAG,CAAC,CACb,KAAK,IAAI,CACX,CAAC;AACJ,CAAC;AAED,MAAM,UAAU,eAAe,CAC7B,OAAgB,EAChB,UAAoB,EACpB,iBAA2B;IAE3B,OAAO,CAAC,aAAa,CACnB,cAAc,CACZ,WAAW;IACT,iDAAiD;IACjD,UAAU,CAAC,eAAe,EAC1B,iBAAiB,CAAC,eAAe,EACjC;QACE,KAAK,EAAE,GAAG,CAAC,wBAAwB,CAAC;QACpC,QAAQ,EAAE,CAAC,IAA4B,EAAW,EAAE,CAClD,IAAI,CAAC,MAAM,YAAY,OAAO;YAC5B,CAAC,CAAC,IAAI,CAAC,MAAM,CAAC,OAAO,KAAK,OAAO;gBAC/B,CAAC,CAAC,IAAI,CAAC,UAAU,EAAE,OAAO,EAAE,QAAQ,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC,KAAK,IAAI;oBACzD,gBAAgB,CAAC,iBAAiB,EAAE,QAAQ,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC;gBAC5D,CAAC,CAAC,IAAI,CAAC,MAAM,CAAC,OAAO,KAAK,YAAY;oBACpC,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC,QAAQ,CAAC,QAAQ,CAAS,IAAI,CAAC,MAAM,CAAC,OAAO,CAAC;YAC/D,CAAC,CAAC,IAAI,CAAC,MAAM,KAAK,IAAI;QAC1B,QAAQ,EAAE,CAAC,IAA4B,EAAW,EAAE,CAClD,IAAI,CAAC,MAAM,YAAY,OAAO;YAC9B,IAAI,CAAC,MAAM,CAAC,OAAO,KAAK,OAAO;YAC/B,CAAC,IAAI,CAAC,UAAU,EAAE,OAAO,EAAE,QAAQ,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC,KAAK,IAAI;gBACxD,CAAC,gBAAgB,CAAC,iBAAiB,EAAE,QAAQ,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC,CAAC;QAChE,IAAI,EAAE,GAAY,EAAE,CAAC,IAAI;KAC1B,CACF,CACF,CACF,CAAC;AACJ,CAAC;AAED,MAAM,CAAC,OAAO,OAAO,sBAAuB,SAAQ,UAAU;IAK5D,KAAK,CAAC,gBAAgB,CAAC,KAAY;QACjC,MAAM,IAAI,GACkB,KAAK,CAAC,MAAO,EAAE,KAAK,EAAE,IAAI,CAAC,CAAC,CAAC,IAAI,KAAK,CAAC;QACnE,IAAI,CAAC,IAAI,EAAE;YACT,OAAO;SACR;QACD,MAAM,IAAI,GAAG,MAAM,IAAI,CAAC,IAAI,EAAE,CAAC;QAC/B,MAAM,GAAG,GAAG,IAAI,SAAS,EAAE,CAAC,eAAe,CAAC,IAAI,EAAE,iBAAiB,CAAC,CAAC;QAErE,eAAe,CAAC,IAAI,EAAE,IAAI,CAAC,GAAG,EAAE,GAAG,CAAC,CAAC;QACrC,IAAI,CAAC,YAAY,CAAC,QAAQ,GAAG,IAAI,CAAC;IACpC,CAAC;IAED,KAAK,CAAC,GAAG;QACP,IAAI,CAAC,YAAY,CAAC,KAAK,EAAE,CAAC;IAC5B,CAAC;IAED,MAAM;QACJ,OAAO,IAAI,CAAA,iBAAiB,CAAC,KAAiB,EAAE,EAAE,CAChD,CAAoB,KAAK,CAAC,MAAO,CAAC,KAAK,GAAG,EAAE,CAAC;iCAClB,IAAI,CAAC,gBAAgB;kHAC4D,CAAC;IACjH,CAAC;;AAEM,6BAAM,GAAG,GAAG,CAAA;;;;;;GAMlB,CAAC;AAhCwC;IAAzC,KAAK,CAAC,iCAAiC,CAAC;4DAAiC","sourcesContent":["import { css, html, LitElement, query, TemplateResult } from 'lit-element';\nimport { get } from 'lit-translate';\n\nimport {\n  crossProduct,\n  find,\n  identity,\n  newWizardEvent,\n  SCLTag,\n  tags,\n} from '@openscd/open-scd/src/foundation.js';\nimport { Diff, mergeWizard } from '@openscd/open-scd/src/wizards.js';\n\nexport function isValidReference(\n  doc: XMLDocument,\n  identity: string | number\n): boolean {\n  if (typeof identity !== 'string') return false;\n  const [iedName, ldInst, prefix, lnClass, lnInst] = identity.split(/[ /]/);\n\n  if (!iedName || !lnClass) return false;\n\n  if (ldInst === '(Client)') {\n    const [\n      iedNameSelectors,\n      prefixSelectors,\n      lnClassSelectors,\n      lnInstSelectors,\n    ] = [\n      [`IED[name=\"${iedName}\"]`],\n      prefix ? [`[prefix=\"${prefix}\"]`] : [':not([prefix])', '[prefix=\"\"]'],\n      [`LN[lnClass=\"${lnClass}\"]`],\n      lnInst ? [`[inst=\"${lnInst}\"]`] : [':not([inst])', '[inst=\"\"]'],\n    ];\n\n    return (\n      doc.querySelector(\n        crossProduct(\n          iedNameSelectors,\n          ['>AccessPoint>'],\n          lnClassSelectors,\n          prefixSelectors,\n          lnInstSelectors\n        )\n          .map(strings => strings.join(''))\n          .join(',')\n      ) !== null\n    );\n  }\n\n  const [\n    iedNameSelectors,\n    ldInstSelectors,\n    prefixSelectors,\n    lnClassSelectors,\n    lnInstSelectors,\n  ] = [\n    [`IED[name=\"${iedName}\"]`],\n    [`LDevice[inst=\"${ldInst}\"]`],\n    prefix ? [`[prefix=\"${prefix}\"]`] : [':not([prefix])', '[prefix=\"\"]'],\n    lnClass === 'LLN0' ? [`LN0`] : [`LN[lnClass=\"${lnClass}\"]`],\n    lnInst ? [`[inst=\"${lnInst}\"]`] : [':not([inst])', '[inst=\"\"]'],\n  ];\n\n  return (\n    doc.querySelector(\n      crossProduct(\n        iedNameSelectors,\n        [' '],\n        ldInstSelectors,\n        ['>'],\n        lnClassSelectors,\n        prefixSelectors,\n        lnInstSelectors\n      )\n        .map(strings => strings.join(''))\n        .join(',')\n    ) !== null\n  );\n}\n\nexport function mergeSubstation(\n  element: Element,\n  currentDoc: Document,\n  docWithSubstation: Document\n): void {\n  element.dispatchEvent(\n    newWizardEvent(\n      mergeWizard(\n        // FIXME: doesn't work with multiple Substations!\n        currentDoc.documentElement,\n        docWithSubstation.documentElement,\n        {\n          title: get('updatesubstation.title'),\n          selected: (diff: Diff<Element | string>): boolean =>\n            diff.theirs instanceof Element\n              ? diff.theirs.tagName === 'LNode'\n                ? find(currentDoc, 'LNode', identity(diff.theirs)) === null &&\n                  isValidReference(docWithSubstation, identity(diff.theirs))\n                : diff.theirs.tagName === 'Substation' ||\n                  !tags['SCL'].children.includes(<SCLTag>diff.theirs.tagName)\n              : diff.theirs !== null,\n          disabled: (diff: Diff<Element | string>): boolean =>\n            diff.theirs instanceof Element &&\n            diff.theirs.tagName === 'LNode' &&\n            (find(currentDoc, 'LNode', identity(diff.theirs)) !== null ||\n              !isValidReference(docWithSubstation, identity(diff.theirs))),\n          auto: (): boolean => true,\n        }\n      )\n    )\n  );\n}\n\nexport default class UpdateSubstationPlugin extends LitElement {\n  doc!: XMLDocument;\n\n  @query('#update-substation-plugin-input') pluginFileUI!: HTMLInputElement;\n\n  async updateSubstation(event: Event): Promise<void> {\n    const file =\n      (<HTMLInputElement | null>event.target)?.files?.item(0) ?? false;\n    if (!file) {\n      return;\n    }\n    const text = await file.text();\n    const doc = new DOMParser().parseFromString(text, 'application/xml');\n\n    mergeSubstation(this, this.doc, doc);\n    this.pluginFileUI.onchange = null;\n  }\n\n  async run(): Promise<void> {\n    this.pluginFileUI.click();\n  }\n\n  render(): TemplateResult {\n    return html`<input @click=${(event: MouseEvent) =>\n      ((<HTMLInputElement>event.target).value = '')}\n                       @change=${this.updateSubstation}\n                       id=\"update-substation-plugin-input\" accept=\".sed,.scd,.ssd,.iid,.cid\" type=\"file\"></input>`;\n  }\n\n  static styles = css`\n    input {\n      width: 0;\n      height: 0;\n      opacity: 0;\n    }\n  `;\n}\n"]}