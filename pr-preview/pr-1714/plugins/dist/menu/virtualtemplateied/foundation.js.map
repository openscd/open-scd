{"version":3,"file":"foundation.js","sourceRoot":"","sources":["../../../src/menu/virtualtemplateied/foundation.ts"],"names":[],"mappings":"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","sourcesContent":["import {\n  identity,\n} from '@openscd/open-scd/src/foundation.js';\n\nimport {\n  createElement,\n  getChildElementsByTagName,\n} from '@openscd/xml';\n\nconst functionTypeElementTags = [\n  'Function',\n  'SubFunction',\n  'EqFunction',\n  'EqSubFunction',\n];\n\nconst functionTypeSelector = functionTypeElementTags.join(',');\n\n/**\n * @param element - Some element Function, SubFunction, EqFunction or EqSubFunction\n * @returns Whether the element is a leaf function acc. to IEC 61850-6-100\n * */\nexport function isLeafFunction(element: Element | null): boolean {\n  if (!element) return false;\n\n  if (element.tagName !== 'SubFunction' && element.tagName !== 'EqSubFunction')\n    return false;\n\n  return (\n    element.children.length === 1 && element.children[0].tagName === 'LNode'\n  );\n}\n\n/** @returns closest non-leaf function type parent element */\nexport function getNonLeafParent(element: Element | null): Element | null {\n  if (!element) return null;\n\n  const directParent = element.parentElement;\n  if (!directParent || !functionTypeElementTags.includes(directParent.tagName))\n    return null;\n\n  if (isLeafFunction(directParent)) return getNonLeafParent(directParent);\n\n  return directParent;\n}\n\n/** @returns prefix of LNode element acc. to IEC 61850-6-100 */\nexport function getFunctionNamingPrefix(lNode: Element): string {\n  const lNodesPrefix = lNode.getAttribute('prefix');\n  if (lNodesPrefix) return lNodesPrefix;\n\n  return isLeafFunction(lNode.parentElement)\n    ? lNode.parentElement?.getAttribute('name') ?? ''\n    : '';\n}\n\nfunction canFunctionBeConvertedToLDevice(element: Element): boolean {\n  if (!functionTypeElementTags.includes(element.tagName)) return true;\n\n  return (\n    !isLeafFunction(element) &&\n    getChildElementsByTagName(element, 'LNode').length > 1\n  );\n}\n\nfunction shortestIdentities(identities: string[]): string[] {\n  const lengths = identities.map(identity => identity.split('>').length);\n  const maxLength = Math.max(...lengths);\n\n  let i = 1;\n  while (i <= maxLength) {\n    const next = identities.map(identity =>\n      identity.split('>').slice(-i).join('_')\n    );\n    if (new Set(next).size === next.length) return next;\n    i++;\n  }\n\n  return identities.map(identity => identity.split('>').join('_'));\n}\n\nexport function getUniqueFunctionName(element: Element): string {\n  if (!functionTypeElementTags.includes(element.tagName)) {\n    const id = identity(element);\n    return typeof id === 'string' ? id : '';\n  }\n\n  const name = element.getAttribute('name');\n  if (!name) return identity(element) as string;\n\n  const sameNamed = Array.from(\n    element.ownerDocument.querySelectorAll(functionTypeSelector)\n  )\n    .filter(functionElement => canFunctionBeConvertedToLDevice(functionElement))\n    .filter(\n      functionElement =>\n        functionElement !== element &&\n        functionElement.getAttribute('name') === name\n    )\n    .map(functionElement => identity(functionElement) as string);\n\n  return shortestIdentities([identity(element) as string, ...sameNamed])[0];\n}\ntype AnyLNDescription = {\n  lnClass: string;\n  inst: string;\n  prefix: string | null;\n  lnType: string;\n};\n\nexport type LDeviceDescription = {\n  validLdInst: string;\n  anyLNs: AnyLNDescription[];\n};\n\nexport type VirtualIEDDescription = {\n  manufacturer: string;\n  desc: string | null;\n  apName: string;\n  lDevices: LDeviceDescription[];\n};\n\n/** @returns schema valid SPECIFICATION type IED based on virtualIED object  */\nexport function getSpecificationIED(\n  ownerDocument: Document,\n  virtualIED: VirtualIEDDescription\n): Element {\n  const ied = createElement(ownerDocument, 'IED', {\n    name: 'SPECIFICATION',\n    desc: virtualIED.desc,\n    manufacturer: virtualIED.manufacturer,\n  });\n\n  const accessPoint = createElement(ownerDocument, 'AccessPoint', {\n    name: virtualIED.apName,\n  });\n\n  const server = createElement(ownerDocument, 'Server', {});\n\n  // next two line required for schema validity\n  const authentication = createElement(ownerDocument, 'Authentication', {});\n  server.appendChild(authentication);\n\n  Object.values(virtualIED.lDevices).forEach(lDeviceDesc => {\n    const lDevice = createElement(ownerDocument, 'LDevice', {\n      inst: lDeviceDesc.validLdInst,\n    });\n\n    lDeviceDesc.anyLNs.forEach(anyLNDesc => {\n      const anyLN = createElement(\n        ownerDocument,\n        anyLNDesc.lnClass === 'LLN0' ? 'LN0' : 'LN',\n        {\n          prefix: anyLNDesc.prefix,\n          lnClass: anyLNDesc.lnClass,\n          inst: anyLNDesc.inst,\n          lnType: anyLNDesc.lnType,\n        }\n      );\n\n      lDevice.appendChild(anyLN);\n    });\n\n    server.appendChild(lDevice);\n  });\n\n  ied.appendChild(accessPoint);\n  accessPoint.appendChild(server);\n\n  return ied;\n}\n"]}