{"version":3,"file":"scl.js","sourceRoot":"","sources":["../../src/foundation/scl.ts"],"names":[],"mappings":"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","sourcesContent":["import { crossProduct } from '../foundation.js';\n\nfunction getDataModelChildren(parent: Element): Element[] {\n  if (['LDevice', 'Server'].includes(parent.tagName))\n    return Array.from(parent.children).filter(\n      child =>\n        child.tagName === 'LDevice' ||\n        child.tagName === 'LN0' ||\n        child.tagName === 'LN'\n    );\n\n  const id =\n    parent.tagName === 'LN' || parent.tagName === 'LN0'\n      ? parent.getAttribute('lnType')\n      : parent.getAttribute('type');\n\n  return Array.from(\n    parent.ownerDocument.querySelectorAll(\n      `LNodeType[id=\"${id}\"] > DO, DOType[id=\"${id}\"] > SDO, DOType[id=\"${id}\"] > DA, DAType[id=\"${id}\"] > BDA`\n    )\n  );\n}\n\nexport function existFcdaReference(fcda: Element, ied: Element): boolean {\n  const [ldInst, prefix, lnClass, lnInst, doName, daName, fc] = [\n    'ldInst',\n    'prefix',\n    'lnClass',\n    'lnInst',\n    'doName',\n    'daName',\n    'fc',\n  ].map(attr => fcda.getAttribute(attr));\n\n  const sinkLdInst = ied.querySelector(`LDevice[inst=\"${ldInst}\"]`);\n  if (!sinkLdInst) return false;\n\n  const prefixSelctors = prefix\n    ? [`[prefix=\"${prefix}\"]`]\n    : ['[prefix=\"\"]', ':not([prefix])'];\n  const lnInstSelectors = lnInst\n    ? [`[inst=\"${lnInst}\"]`]\n    : ['[inst=\"\"]', ':not([inst])'];\n\n  const anyLnSelector = crossProduct(\n    ['LN0', 'LN'],\n    prefixSelctors,\n    [`[lnClass=\"${lnClass}\"]`],\n    lnInstSelectors\n  )\n    .map(strings => strings.join(''))\n    .join(',');\n\n  const sinkAnyLn = ied.querySelector(anyLnSelector);\n  if (!sinkAnyLn) return false;\n\n  const doNames = doName?.split('.');\n  if (!doNames) return false;\n\n  let parent: Element | undefined = sinkAnyLn;\n  for (const doNameAttr of doNames) {\n    parent = getDataModelChildren(parent).find(\n      child => child.getAttribute('name') === doNameAttr\n    );\n    if (!parent) return false;\n  }\n\n  const daNames = daName?.split('.');\n  const someFcInSink = getDataModelChildren(parent).some(\n    da => da.getAttribute('fc') === fc\n  );\n  if (!daNames && someFcInSink) return true;\n  if (!daNames) return false;\n\n  let sinkFc = '';\n  for (const daNameAttr of daNames) {\n    parent = getDataModelChildren(parent).find(\n      child => child.getAttribute('name') === daNameAttr\n    );\n\n    if (parent?.getAttribute('fc')) sinkFc = parent.getAttribute('fc')!;\n\n    if (!parent) return false;\n  }\n\n  if (sinkFc !== fc) return false;\n\n  return true;\n}\n"]}