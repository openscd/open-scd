{"version":3,"file":"address.js","sourceRoot":"","sources":["../../../../src/editors/protocol104/wizards/address.ts"],"names":[],"mappings":"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","sourcesContent":["import { html, TemplateResult } from 'lit-element';\nimport { get } from 'lit-translate';\nimport { live } from 'lit-html/directives/live';\n\nimport '@material/mwc-list/mwc-list-item';\nimport '@material/mwc-select';\nimport '@material/mwc-textarea';\n\nimport {\n  getNameAttribute,\n  getValue,\n  patterns,\n  Wizard,\n  WizardActor,\n  WizardInputElement,\n} from '@openscd/open-scd/src/foundation.js';\n\nimport { cloneElement } from '@openscd/xml';\n\nimport { EditorAction } from '@openscd/core/foundation/deprecated/editor.js';\n\nimport '@openscd/open-scd/src/wizard-textfield.js';\nimport '@openscd/open-scd/src/wizard-select.js';\n\nimport {\n  getCdcValueFromDOIElement,\n  getEnumVal,\n  getFullPath,\n} from '../foundation/foundation.js';\nimport { hasScaleFields, hasUnitMultiplierField } from '../foundation/cdc.js';\nimport { getSignalName } from '../foundation/signalNames.js';\n\nconst allowedMultipliers = [\n  'm',\n  'k',\n  'M',\n  'mu',\n  'y',\n  'z',\n  'a',\n  'f',\n  'p',\n  'n',\n  'c',\n  'd',\n  'da',\n  'h',\n  'G',\n  'T',\n  'P',\n  'E',\n  'Z',\n  'Y',\n];\n\nexport function updateAddressValue(\n  doiElement: Element,\n  daiElement: Element,\n  addressElement: Element\n): WizardActor {\n  return (inputs: WizardInputElement[]): EditorAction[] => {\n    const foundCdc = getCdcValueFromDOIElement(doiElement) ?? '';\n    const cdc = foundCdc === 'WYE' || foundCdc === 'DEL' ? 'CMV' : foundCdc;\n    const ti = addressElement.getAttribute('ti') ?? '';\n\n    const casdu = getValue(inputs.find(i => i.label === 'casdu')!)!;\n    const ioa = getValue(inputs.find(i => i.label === 'ioa')!);\n    const unitMultiplier = hasUnitMultiplierField(cdc, ti)\n      ? getValue(inputs.find(i => i.label === 'unitMultiplier')!)\n      : null;\n    const scaleMultiplier = hasScaleFields(cdc, ti)\n      ? getValue(inputs.find(i => i.label === 'scaleMultiplier')!)\n      : null;\n    const scaleOffset = hasScaleFields(cdc, ti)\n      ? getValue(inputs.find(i => i.label === 'scaleOffset')!)\n      : null;\n\n    if (\n      casdu === addressElement.getAttribute('casdu') &&\n      ioa === addressElement.getAttribute('ioa') &&\n      unitMultiplier === addressElement.getAttribute('unitMultiplier') &&\n      scaleMultiplier === addressElement.getAttribute('scaleMultiplier') &&\n      scaleOffset === addressElement.getAttribute('scaleOffset')\n    ) {\n      return [];\n    }\n\n    const newElement = cloneElement(addressElement, {\n      casdu,\n      ioa,\n      unitMultiplier,\n      scaleMultiplier,\n      scaleOffset,\n    });\n\n    return [\n      { old: { element: addressElement! }, new: { element: newElement } },\n    ];\n  };\n}\n\nexport function editAddressWizard(\n  iedElement: Element,\n  doiElement: Element,\n  daiElement: Element,\n  addressElement: Element\n): Wizard {\n  function renderAddressWizard(): TemplateResult[] {\n    const foundCdc = getCdcValueFromDOIElement(doiElement) ?? '';\n    const reqCmvMapping = foundCdc === 'WYE' || foundCdc === 'DEL';\n    const cdc = reqCmvMapping ? 'CMV' : foundCdc;\n    const ti = addressElement.getAttribute('ti') ?? '';\n\n    let casdu = addressElement.getAttribute('casdu') ?? '';\n\n    function validateIOA(\n      this: WizardInputElement,\n      value: string\n    ): Partial<ValidityState> {\n      const existingAddress = iedElement.querySelector(\n        `Address[casdu=\"${casdu}\"][ioa=\"${value}\"]`\n      );\n      if (existingAddress) {\n        this.validationMessage = get('protocol104.wizard.error.ioaConflict');\n        return {\n          valid: false,\n          customError: true,\n        };\n      }\n      return {};\n    }\n\n    // Add the basic fields to the list.\n    const fields: TemplateResult[] = [\n      html`<wizard-textfield\n        label=\"IED\"\n        .maybeValue=\"${getNameAttribute(iedElement)}\"\n        disabled\n        readonly\n      >\n      </wizard-textfield>`,\n      html`<mwc-textarea\n        label=\"DOI\"\n        value=\"${getFullPath(doiElement, 'IED')}\"\n        rows=\"2\"\n        cols=\"40\"\n        readonly\n        disabled\n      >\n      </mwc-textarea>`,\n      html`<wizard-textfield\n        label=\"cdc\"\n        .maybeValue=\"${cdc}\"\n        .helper=\"${reqCmvMapping\n          ? get('protocol104.mappedCmv', { cdc: foundCdc })\n          : ''}\"\n        .helperPersistent=\"${reqCmvMapping}\"\n        disabled\n        readonly\n      >\n      </wizard-textfield>`,\n      html`<mwc-textarea\n        label=\"DAI\"\n        value=\"${getFullPath(daiElement!, 'DOI')}\"\n        rows=\"2\"\n        cols=\"40\"\n        readonly\n        disabled\n      >\n      </mwc-textarea>`,\n      html`<wizard-textfield\n        label=\"casdu\"\n        @change=\"${(evt: Event) => {\n          casdu = (<WizardInputElement>evt.target).value ?? '';\n        }}}\"\n        .maybeValue=\"${live(addressElement.getAttribute('casdu') ?? '')}\"\n        helper=\"${get('protocol104.wizard.casduHelper')}\"\n        required\n      >\n      </wizard-textfield>`,\n      html`<wizard-textfield\n        .validityTransform=\"${validateIOA}\"\n        label=\"ioa\"\n        .maybeValue=\"${live(addressElement.getAttribute('ioa') ?? '')}\"\n        helper=\"${get('protocol104.wizard.ioaHelper')}\"\n        required\n      >\n      </wizard-textfield>`,\n      html`<wizard-textfield\n        label=\"ti\"\n        .maybeValue=${ti + ' (' + getSignalName(ti) + ')'}\n        disabled\n        readonly\n      >\n      </wizard-textfield>`,\n    ];\n\n    if (hasUnitMultiplierField(cdc, ti)) {\n      fields.push(html`<wizard-select\n        label=\"unitMultiplier\"\n        .maybeValue=\"${addressElement.getAttribute('unitMultiplier')}\"\n        helper=\"${get('protocol104.wizard.unitMultiplierHelper')}\"\n        fixedMenuPosition\n        nullable\n      >\n        ${allowedMultipliers.map(\n          multiplier =>\n            html`<mwc-list-item value=\"${multiplier}\">\n              <span>${multiplier}</span>\n            </mwc-list-item>`\n        )}\n      </wizard-select>`);\n    }\n\n    if (hasScaleFields(cdc, ti)) {\n      fields.push(html`<wizard-textfield\n        label=\"scaleMultiplier\"\n        .maybeValue=\"${addressElement.getAttribute('scaleMultiplier')}\"\n        helper=\"${get('protocol104.wizard.scaleMultiplierHelper')}\"\n        pattern=\"${patterns.decimal}\"\n        nullable\n      >\n      </wizard-textfield>`);\n\n      fields.push(html`<wizard-textfield\n        label=\"scaleOffset\"\n        .maybeValue=\"${addressElement.getAttribute('scaleOffset')}\"\n        helper=\"${get('protocol104.wizard.scaleOffsetHelper')}\"\n        pattern=\"${patterns.decimal}\"\n        nullable\n      >\n      </wizard-textfield>`);\n    }\n\n    const expectedValue = addressElement.getAttribute('expectedValue');\n    if (expectedValue) {\n      fields.push(html`<wizard-textfield\n        label=\"expectedValue\"\n        .maybeValue=\"${expectedValue}\"\n        disabled\n        readonly\n      >\n      </wizard-textfield>`);\n      fields.push(html`<wizard-textfield\n        label=\"enumValue\"\n        .maybeValue=\"${getEnumVal(daiElement, expectedValue)}\"\n        disabled\n        readonly\n      >\n      </wizard-textfield>`);\n    }\n\n    if (addressElement.hasAttribute('inverted')) {\n      fields.push(html`<wizard-textfield\n        label=\"inverted\"\n        .maybeValue=\"${addressElement.getAttribute('inverted')}\"\n        disabled\n        readonly\n      >\n      </wizard-textfield>`);\n    }\n\n    if (addressElement.hasAttribute('check')) {\n      fields.push(html`<wizard-textfield\n        label=\"check\"\n        .maybeValue=\"${addressElement.getAttribute('check')}\"\n        disabled\n        readonly\n      >\n      </wizard-textfield>`);\n    }\n\n    return fields;\n  }\n\n  return [\n    {\n      title: get('protocol104.wizard.title.addressEdit'),\n      element: addressElement,\n      primary: {\n        icon: 'edit',\n        label: get('save'),\n        action: updateAddressValue(doiElement, daiElement, addressElement),\n      },\n      content: renderAddressWizard(),\n    },\n  ];\n}\n"]}