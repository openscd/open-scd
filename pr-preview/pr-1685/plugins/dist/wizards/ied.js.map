{"version":3,"file":"ied.js","sourceRoot":"","sources":["../../src/wizards/ied.ts"],"names":[],"mappings":"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","sourcesContent":["import { html, TemplateResult } from 'lit-element';\nimport { get } from 'lit-translate';\n\nimport '@material/mwc-list';\nimport '@material/mwc-list/mwc-list-item';\n\nimport '@openscd/open-scd/src/wizard-textfield.js';\nimport {\n  identity,\n  isPublic,\n  newSubWizardEvent,\n  newWizardEvent,\n  Wizard,\n  WizardActor,\n  WizardInputElement,\n  WizardMenuActor,\n} from '@openscd/open-scd/src/foundation.js';\nimport { \n  ComplexAction,\n  Delete,\n  EditorAction,\n  newActionEvent\n} from '@openscd/core/foundation/deprecated/editor.js';\nimport { patterns } from './foundation/limits.js';\n\nimport { updateNamingAttributeWithReferencesAction } from './foundation/actions.js';\nimport { deleteReferences } from './foundation/references.js';\nimport { emptyInputsDeleteActions } from '@openscd/open-scd/src/foundation/ied.js';\n\nconst iedNamePattern =\n  '[A-Za-z][0-9A-Za-z_]{0,2}|' +\n  '[A-Za-z][0-9A-Za-z_]{4,63}|' +\n  '[A-MO-Za-z][0-9A-Za-z_]{3}|' +\n  'N[0-9A-Za-np-z_][0-9A-Za-z_]{2}|' +\n  'No[0-9A-Za-mo-z_][0-9A-Za-z_]|' +\n  'Non[0-9A-Za-df-z_]';\n\nexport function renderIEDWizard(\n  name: string | null,\n  desc: string | null,\n  type: string | null,\n  manufacturer: string | null,\n  configVersion: string | null,\n  originalSclVersion: string,\n  engRight: string | null,\n  owner: string | null,\n  reservedNames: string[]\n): TemplateResult[] {\n  return [\n    html`<wizard-textfield\n      label=\"name\"\n      .maybeValue=${name}\n      helper=\"${get('ied.wizard.nameHelper')}\"\n      required\n      validationMessage=\"${get('textfield.required')}\"\n      dialogInitialFocus\n      .reservedValues=${reservedNames}\n      pattern=\"${iedNamePattern}\"\n    ></wizard-textfield>`,\n    html`<wizard-textfield\n      label=\"desc\"\n      .maybeValue=${desc}\n      nullable\n      helper=\"${get('ied.wizard.descHelper')}\"\n      pattern=\"${patterns.normalizedString}\"\n    ></wizard-textfield>`,\n    html`<wizard-textfield\n      label=\"type\"\n      .maybeValue=${type || '-'}\n      readOnly\n      disabled\n    ></wizard-textfield>`,\n    html`<wizard-textfield\n      label=\"manufacturer\"\n      .maybeValue=${manufacturer || '-'}\n      readOnly\n      disabled\n    ></wizard-textfield>`,\n    html`<wizard-textfield\n      label=\"configVersion\"\n      .maybeValue=${configVersion || '-'}\n      readOnly\n      disabled\n    ></wizard-textfield>`,\n    html`<wizard-textfield\n      label=\"originalSclVersion\"\n      .maybeValue=${originalSclVersion || '-'}\n      readOnly\n      disabled\n    ></wizard-textfield>`,\n    html`<wizard-textfield\n      label=\"engRight\"\n      .maybeValue=${engRight || '-'}\n      readOnly\n      disabled\n    ></wizard-textfield>`,\n    html`<wizard-textfield\n      label=\"owner\"\n      .maybeValue=${owner || '-'}\n      readOnly\n      disabled\n    ></wizard-textfield>`,\n  ];\n}\n\nfunction renderIEDReferencesWizard(references: Delete[]): TemplateResult[] {\n  return [\n    html` <section>\n      <h1>${get('ied.wizard.title.references')}</h1>\n      <mwc-list>\n        ${references.map(reference => {\n          const oldElement = <Element>reference.old.element;\n          return html` <mwc-list-item noninteractive twoline>\n            <span>${oldElement.tagName}</span>\n            <span slot=\"secondary\"\n              >${identity(<Element>reference.old.element)}</span\n            >\n          </mwc-list-item>`;\n        })}\n      </mwc-list>\n    </section>`,\n  ];\n}\n\nfunction validatedVersionAttribute(element: Element): string {\n  return (element.getAttribute('originalSclVersion') ?? '')\n    .concat(element.getAttribute('originalSclRevision') ?? '')\n    .concat(element.getAttribute('originalSclRelease') ?? '');\n}\n\nexport function reservedNamesIED(currentElement: Element): string[] {\n  return Array.from(currentElement.parentNode!.querySelectorAll('IED'))\n    .filter(isPublic)\n    .map(ied => ied.getAttribute('name') ?? '')\n    .filter(name => name !== currentElement.getAttribute('name'));\n}\n\nexport function removeIEDAndReferences(element: Element): WizardActor {\n  return (inputs: WizardInputElement[], wizard: Element): EditorAction[] => {\n    // Close Edit Wizard, if open.\n    wizard.dispatchEvent(newWizardEvent());\n\n    // Get Delete Actions for other elements that also need to be removed\n    const referencesDeleteActions = deleteReferences(element);\n    // Use the ExtRef Elements to check if after removing the ExtRef there are empty Inputs that can also be removed.\n    const extRefsDeleteActions = referencesDeleteActions.filter(\n      deleteAction => (<Element>deleteAction.old.element).tagName === 'ExtRef'\n    );\n    const inputsDeleteActions = emptyInputsDeleteActions(extRefsDeleteActions);\n\n    // Create Complex Action to remove IED and all references.\n    const name = element.getAttribute('name') ?? 'Unknown';\n    const complexAction: ComplexAction = {\n      actions: [],\n      title: get('ied.action.deleteied', { name }),\n    };\n    complexAction.actions.push({\n      old: { parent: element.parentElement!, element },\n    });\n    complexAction.actions.push(...referencesDeleteActions);\n    complexAction.actions.push(...inputsDeleteActions);\n    return [complexAction];\n  };\n}\n\nexport function removeIEDWizard(element: Element): Wizard | null {\n  // Check if the IED has any references, if so show wizard with all references.\n  const references = deleteReferences(element);\n  if (references.length > 0) {\n    return [\n      {\n        title: get('ied.wizard.title.delete'),\n        content: renderIEDReferencesWizard(references),\n        primary: {\n          icon: 'delete',\n          label: get('remove'),\n          action: removeIEDAndReferences(element),\n        },\n      },\n    ];\n  }\n  return null;\n}\n\nexport function editIEDWizard(element: Element): Wizard {\n  function removeIED(element: Element): WizardMenuActor {\n    return (wizard: Element): void => {\n      const removeWizard = removeIEDWizard(element);\n      if (removeWizard)\n        wizard.dispatchEvent(newSubWizardEvent(() => removeWizard));\n\n      // If no Wizard is needed, just remove the element.\n      wizard.dispatchEvent(\n        newActionEvent({ old: { parent: element.parentElement!, element } })\n      );\n      wizard.dispatchEvent(newWizardEvent());\n    };\n  }\n\n  return [\n    {\n      title: get('ied.wizard.title.edit'),\n      element,\n      menuActions: [\n        {\n          icon: 'delete',\n          label: get('remove'),\n          action: removeIED(element),\n        },\n      ],\n      primary: {\n        icon: 'edit',\n        label: get('save'),\n        action: updateNamingAttributeWithReferencesAction(\n          element,\n          'ied.action.updateied'\n        ),\n      },\n      content: renderIEDWizard(\n        element.getAttribute('name'),\n        element.getAttribute('desc'),\n        element.getAttribute('type'),\n        element.getAttribute('manufacturer'),\n        element.getAttribute('configVersion'),\n        validatedVersionAttribute(element),\n        element.getAttribute('engRight'),\n        element.getAttribute('owner'),\n        reservedNamesIED(element)\n      ),\n    },\n  ];\n}\n"]}