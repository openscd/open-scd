{"version":3,"file":"voltagelevel.js","sourceRoot":"","sources":["../../src/wizards/voltagelevel.ts"],"names":[],"mappings":"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","sourcesContent":["import { html, TemplateResult } from 'lit-html';\nimport { get } from 'lit-translate';\n\nimport { cloneElement, createElement } from '@openscd/xml';\n\nimport '@openscd/open-scd/src/wizard-textfield.js';\nimport {\n  getMultiplier,\n  getValue,\n  patterns,\n  Wizard,\n  WizardActor,\n  WizardInputElement,\n} from '@openscd/open-scd/src/foundation.js';\nimport {\n  ComplexAction,\n  EditorAction,\n  SimpleAction,\n} from '@openscd/core/foundation/deprecated/editor';\n\nimport { updateReferences } from './foundation/references.js';\n\nconst initial = {\n  nomFreq: '50',\n  numPhases: '3',\n  Voltage: '110',\n  multiplier: 'k',\n};\n\nfunction render(\n  name: string,\n  desc: string | null,\n  nomFreq: string | null,\n  numPhases: string | null,\n  Voltage: string | null,\n  multiplier: string | null\n): TemplateResult[] {\n  return [\n    html`<wizard-textfield\n      label=\"name\"\n      .maybeValue=${name}\n      helper=\"${get('voltagelevel.wizard.nameHelper')}\"\n      required\n      validationMessage=\"${get('textfield.required')}\"\n      dialogInitialFocus\n    ></wizard-textfield>`,\n    html`<wizard-textfield\n      label=\"desc\"\n      .maybeValue=${desc}\n      nullable\n      helper=\"${get('voltagelevel.wizard.descHelper')}\"\n    ></wizard-textfield>`,\n    html`<wizard-textfield\n      label=\"nomFreq\"\n      .maybeValue=${nomFreq}\n      nullable\n      helper=\"${get('voltagelevel.wizard.nomFreqHelper')}\"\n      suffix=\"Hz\"\n      required\n      validationMessage=\"${get('textfield.nonempty')}\"\n      pattern=\"${patterns.unsigned}\"\n    ></wizard-textfield>`,\n    html`<wizard-textfield\n      label=\"numPhases\"\n      .maybeValue=${numPhases}\n      nullable\n      helper=\"${get('voltagelevel.wizard.numPhaseHelper')}\"\n      suffix=\"#\"\n      required\n      validationMessage=\"${get('textfield.nonempty')}\"\n      type=\"number\"\n      min=\"1\"\n      max=\"255\"\n    ></wizard-textfield>`,\n    html`<wizard-textfield\n      label=\"Voltage\"\n      .maybeValue=${Voltage}\n      nullable\n      unit=\"V\"\n      .multipliers=${[null, 'G', 'M', 'k', '', 'm']}\n      .multiplier=${multiplier}\n      helper=\"${get('voltagelevel.wizard.voltageHelper')}\"\n      required\n      validationMessage=\"${get('textfield.nonempty')}\"\n      pattern=\"${patterns.decimal}\"\n    ></wizard-textfield>`,\n  ];\n}\n\nexport function createAction(parent: Element): WizardActor {\n  return (inputs: WizardInputElement[]): EditorAction[] => {\n    const name = getValue(inputs.find(i => i.label === 'name')!);\n    const desc = getValue(inputs.find(i => i.label === 'desc')!);\n    const nomFreq = getValue(inputs.find(i => i.label === 'nomFreq')!);\n    const numPhases = getValue(inputs.find(i => i.label === 'numPhases')!);\n    const Voltage = getValue(inputs.find(i => i.label === 'Voltage')!);\n    const multiplier = getMultiplier(inputs.find(i => i.label === 'Voltage')!);\n\n    const element = createElement(parent.ownerDocument, 'VoltageLevel', {\n      name,\n      desc,\n      nomFreq,\n      numPhases,\n    });\n\n    if (Voltage !== null) {\n      const voltageElement = createElement(parent.ownerDocument, 'Voltage', {\n        unit: 'V',\n        multiplier,\n      });\n      voltageElement.textContent = Voltage;\n      element.appendChild(voltageElement);\n    }\n\n    return [\n      {\n        new: {\n          parent,\n          element,\n        },\n      },\n    ];\n  };\n}\n\nexport function voltageLevelCreateWizard(parent: Element): Wizard {\n  return [\n    {\n      title: get('voltagelevel.wizard.title.add'),\n      element: undefined,\n      primary: {\n        icon: 'add',\n        label: get('add'),\n        action: createAction(parent),\n      },\n      content: render(\n        '',\n        '',\n        initial.nomFreq,\n        initial.numPhases,\n        initial.Voltage,\n        initial.multiplier\n      ),\n    },\n  ];\n}\n\nfunction getVoltageAction(\n  oldVoltage: Element | null,\n  Voltage: string | null,\n  multiplier: string | null,\n  voltageLevel: Element\n): SimpleAction {\n  if (oldVoltage === null) {\n    const element = createElement(voltageLevel.ownerDocument, 'Voltage', {\n      unit: 'V',\n      multiplier,\n    });\n    element.textContent = Voltage;\n    return {\n      new: {\n        parent: voltageLevel,\n        element,\n        reference: voltageLevel.firstElementChild,\n      },\n    };\n  }\n\n  if (Voltage === null)\n    return {\n      old: {\n        parent: voltageLevel,\n        element: oldVoltage,\n        reference: oldVoltage.nextSibling,\n      },\n    };\n\n  const newVoltage = cloneElement(oldVoltage, { multiplier });\n  newVoltage.textContent = Voltage;\n\n  return {\n    old: { element: oldVoltage },\n    new: { element: newVoltage },\n  };\n}\n\nexport function updateAction(element: Element): WizardActor {\n  return (inputs: WizardInputElement[]): EditorAction[] => {\n    const name = inputs.find(i => i.label === 'name')!.value!;\n    const desc = getValue(inputs.find(i => i.label === 'desc')!);\n    const nomFreq = getValue(inputs.find(i => i.label === 'nomFreq')!);\n    const numPhases = getValue(inputs.find(i => i.label === 'numPhases')!);\n    const Voltage = getValue(inputs.find(i => i.label === 'Voltage')!);\n    const multiplier = getMultiplier(inputs.find(i => i.label === 'Voltage')!);\n\n    let voltageLevelAction: SimpleAction | null;\n    let voltageAction: SimpleAction | null;\n\n    if (\n      name === element.getAttribute('name') &&\n      desc === element.getAttribute('desc') &&\n      nomFreq === element.getAttribute('nomFreq') &&\n      numPhases === element.getAttribute('numPhases')\n    ) {\n      voltageLevelAction = null;\n    } else {\n      const newElement = cloneElement(element, {\n        name,\n        desc,\n        nomFreq,\n        numPhases,\n      });\n      voltageLevelAction = { old: { element }, new: { element: newElement } };\n    }\n\n    if (\n      Voltage ===\n        (element.querySelector('VoltageLevel > Voltage')?.textContent?.trim() ??\n          null) &&\n      multiplier ===\n        (element\n          .querySelector('VoltageLevel > Voltage')\n          ?.getAttribute('multiplier') ?? null)\n    ) {\n      voltageAction = null;\n    } else {\n      voltageAction = getVoltageAction(\n        element.querySelector('VoltageLevel > Voltage'),\n        Voltage,\n        multiplier,\n        voltageLevelAction?.new.element ?? element\n      );\n    }\n\n    const complexAction: ComplexAction = {\n      actions: [],\n      title: get('voltagelevel.action.updateVoltagelevel', { name }),\n    };\n    if (voltageLevelAction) complexAction.actions.push(voltageLevelAction);\n    if (voltageAction) complexAction.actions.push(voltageAction);\n    complexAction.actions.push(\n      ...updateReferences(element, element.getAttribute('name'), name)\n    );\n    return complexAction.actions.length ? [complexAction] : [];\n  };\n}\n\nexport function voltageLevelEditWizard(element: Element): Wizard {\n  return [\n    {\n      title: get('voltagelevel.wizard.title.edit'),\n      element,\n      primary: {\n        icon: 'edit',\n        label: get('save'),\n        action: updateAction(element),\n      },\n      content: render(\n        element.getAttribute('name') ?? '',\n        element.getAttribute('desc'),\n        element.getAttribute('nomFreq'),\n        element.getAttribute('numPhases'),\n        element.querySelector('VoltageLevel > Voltage')?.textContent?.trim() ??\n          null,\n        element\n          .querySelector('VoltageLevel > Voltage')\n          ?.getAttribute('multiplier') ?? null\n      ),\n    },\n  ];\n}\n"]}