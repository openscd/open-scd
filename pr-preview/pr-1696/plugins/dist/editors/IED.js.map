{"version":3,"file":"IED.js","sourceRoot":"","sources":["../../src/editors/IED.ts"],"names":[],"mappings":"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","sourcesContent":["import {\n  css,\n  html,\n  LitElement,\n  property,\n  PropertyValues,\n  state,\n  TemplateResult,\n} from 'lit-element';\nimport { get } from 'lit-translate';\nimport { nothing } from 'lit-html';\n\nimport '@material/mwc-list/mwc-check-list-item';\nimport '@material/mwc-list/mwc-radio-list-item';\n\nimport '@openscd/open-scd/src/oscd-filter-button.js';\nimport { SelectedItemsChangedEvent } from '@openscd/open-scd/src/oscd-filter-button.js';\n\nimport './ied/ied-container.js';\nimport './ied/element-path.js';\n\nimport {\n  compareNames,\n  getDescriptionAttribute,\n  getNameAttribute,\n} from '@openscd/open-scd/src/foundation.js';\nimport { Nsdoc } from '@openscd/open-scd/src/foundation/nsdoc.js';\nimport { getIcon } from '@openscd/open-scd/src/icons/icons.js';\n\n/** An editor [[`plugin`]] for editing the `IED` section. */\nexport default class IedPlugin extends LitElement {\n  /** The document being edited as provided to plugins by [[`OpenSCD`]]. */\n  @property()\n  doc!: XMLDocument;\n\n  @property({ type: Number })\n  editCount = -1;\n\n  /** All the nsdoc files that are being uploaded via the settings. */\n  @property()\n  nsdoc!: Nsdoc;\n\n  @state()\n  selectedIEDs: string[] = [];\n\n  @state()\n  selectedLNClasses: string[] = [];\n\n  @state()\n  private get iedList(): Element[] {\n    return this.doc\n      ? Array.from(this.doc.querySelectorAll(':root > IED')).sort((a, b) =>\n          compareNames(a, b)\n        )\n      : [];\n  }\n\n  @state()\n  private get lnClassList(): string[][] {\n    const currentIed = this.selectedIed;\n    const uniqueLNClassList: string[] = [];\n    if (currentIed) {\n      return Array.from(currentIed.querySelectorAll('LN0, LN'))\n        .filter(element => element.hasAttribute('lnClass'))\n        .filter(element => {\n          const lnClass = element.getAttribute('lnClass') ?? '';\n          if (uniqueLNClassList.includes(lnClass)) {\n            return false;\n          }\n          uniqueLNClassList.push(lnClass);\n          return true;\n        })\n        .sort((a, b) => {\n          const aLnClass = a.getAttribute('lnClass') ?? '';\n          const bLnClass = b.getAttribute('lnClass') ?? '';\n\n          return aLnClass.localeCompare(bLnClass);\n        })\n        .map(element => {\n          const lnClass = element.getAttribute('lnClass');\n          const label = this.nsdoc.getDataDescription(element).label;\n          return [lnClass, label];\n        }) as string[][];\n    }\n    return [];\n  }\n\n  @state()\n  private get selectedIed(): Element | undefined {\n    // When there is no IED selected, or the selected IED has no parent (IED has been removed)\n    // select the first IED from the List.\n    if (this.selectedIEDs.length >= 1) {\n      const iedList = this.iedList;\n      return iedList.find(element => {\n        const iedName = getNameAttribute(element);\n        return this.selectedIEDs[0] === iedName;\n      });\n    }\n    return undefined;\n  }\n\n  lNClassListOpenedOnce = false;\n\n  protected updated(_changedProperties: PropertyValues): void {\n    super.updated(_changedProperties);\n\n    // When the document is updated, we reset the selected IED if it no longer exists\n    const isDocumentUpdated =\n      _changedProperties.has('doc') ||\n      _changedProperties.has('editCount') ||\n      _changedProperties.has('nsdoc');\n\n    if (isDocumentUpdated) {\n      // if the IED exists, retain selection\n      const iedExists = this.doc?.querySelector(\n        `IED[name=\"${this.selectedIEDs[0]}\"]`\n      );\n\n      if (iedExists) return;\n\n      this.selectedIEDs = [];\n      this.selectedLNClasses = [];\n      this.lNClassListOpenedOnce = false;\n\n      const iedList = this.iedList;\n      if (iedList.length > 0) {\n        const iedName = getNameAttribute(iedList[0]);\n        if (iedName) {\n          this.selectedIEDs = [iedName];\n        }\n      }\n    }\n  }\n\n  private calcSelectedLNClasses(): string[] {\n    const somethingSelected = this.selectedLNClasses.length > 0;\n    const lnClasses = this.lnClassList.map(lnClassInfo => lnClassInfo[0]);\n\n    let selectedLNClasses = lnClasses;\n\n    if (somethingSelected) {\n      selectedLNClasses = lnClasses.filter(lnClass =>\n        this.selectedLNClasses.includes(lnClass)\n      );\n    }\n\n    return selectedLNClasses;\n  }\n\n  render(): TemplateResult {\n    const iedList = this.iedList;\n    if (iedList.length > 0) {\n      return html`<section>\n        <div class=\"header\">\n          <h1>${get('filters')}:</h1>\n\n          <oscd-filter-button\n            id=\"iedFilter\"\n            icon=\"developer_board\"\n            .header=${get('iededitor.iedSelector')}\n            @selected-items-changed=\"${(e: SelectedItemsChangedEvent) => {\n              const equalArrays = <T>(first: T[], second: T[]): boolean => {\n                return (\n                  first.length === second.length &&\n                  first.every((val, index) => val === second[index])\n                );\n              };\n\n              const selectionChanged = !equalArrays(\n                this.selectedIEDs,\n                e.detail.selectedItems\n              );\n\n              if (!selectionChanged) {\n                return;\n              }\n\n              this.lNClassListOpenedOnce = false;\n              this.selectedIEDs = e.detail.selectedItems;\n              this.selectedLNClasses = [];\n              this.requestUpdate('selectedIed');\n            }}\"\n          >\n            ${iedList.map(ied => {\n              const name = getNameAttribute(ied);\n              const descr = getDescriptionAttribute(ied);\n              const type = ied.getAttribute('type');\n              const manufacturer = ied.getAttribute('manufacturer');\n              return html` <mwc-radio-list-item\n                value=\"${name}\"\n                ?twoline=\"${type && manufacturer}\"\n                ?selected=\"${this.selectedIEDs.includes(name ?? '')}\"\n              >\n                ${name} ${descr ? html` (${descr})` : html``}\n                <span slot=\"secondary\">\n                  ${type} ${type && manufacturer ? html`&mdash;` : nothing}\n                  ${manufacturer}\n                </span>\n              </mwc-radio-list-item>`;\n            })}\n          </oscd-filter-button>\n\n          <oscd-filter-button\n            id=\"lnClassesFilter\"\n            multi=\"true\"\n            .header=\"${get('iededitor.lnFilter')}\"\n            @selected-items-changed=\"${(e: SelectedItemsChangedEvent) => {\n              this.selectedLNClasses = e.detail.selectedItems;\n              this.requestUpdate('selectedIed');\n            }}\"\n          >\n            <span slot=\"icon\">${getIcon('lNIcon')}</span>\n            ${this.lnClassList.map(lnClassInfo => {\n              const value = lnClassInfo[0];\n              const label = lnClassInfo[1];\n              return html`<mwc-check-list-item\n                value=\"${value}\"\n                ?selected=\"${this.selectedLNClasses.includes(value)}\"\n              >\n                ${label}\n              </mwc-check-list-item>`;\n            })}\n          </oscd-filter-button>\n\n          <element-path class=\"elementPath\"></element-path>\n        </div>\n\n        <ied-container\n          .editCount=${this.editCount}\n          .doc=${this.doc}\n          .element=${this.selectedIed}\n          .selectedLNClasses=${this.calcSelectedLNClasses()}\n          .nsdoc=${this.nsdoc}\n        ></ied-container>\n      </section>`;\n    }\n    return html`<h1>\n      <span style=\"color: var(--base1)\">${get('iededitor.missing')}</span>\n    </h1>`;\n  }\n\n  static styles = css`\n    :host {\n      width: 100vw;\n    }\n\n    section {\n      padding: 8px 12px 16px;\n    }\n\n    .header {\n      display: flex;\n    }\n\n    h1 {\n      color: var(--mdc-theme-on-surface);\n      font-family: 'Roboto', sans-serif;\n      font-weight: 300;\n      overflow: hidden;\n      white-space: nowrap;\n      text-overflow: ellipsis;\n      margin: 0px;\n      line-height: 48px;\n      padding-left: 0.3em;\n    }\n\n    .elementPath {\n      margin-left: auto;\n      padding-right: 12px;\n    }\n  `;\n}\n"]}