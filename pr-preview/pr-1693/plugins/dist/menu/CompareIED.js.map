{"version":3,"file":"CompareIED.js","sourceRoot":"","sources":["../../src/menu/CompareIED.ts"],"names":[],"mappings":";AAAA,OAAO,EACL,GAAG,EACH,IAAI,EACJ,UAAU,EACV,QAAQ,EACR,KAAK,GAEN,MAAM,aAAa,CAAC;AACrB,OAAO,EAAE,GAAG,EAAE,MAAM,eAAe,CAAC;AAEpC,OAAO,sBAAsB,CAAC;AAC9B,OAAO,oBAAoB,CAAC;AAC5B,OAAO,kCAAkC,CAAC;AAC1C,OAAO,yBAAyB,CAAC;AACjC,OAAO,wBAAwB,CAAC;AAMhC,OAAO,6CAA6C,CAAC;AAErD,OAAO,EACL,YAAY,EACZ,IAAI,EACJ,gBAAgB,EAChB,QAAQ,EACR,QAAQ,GACT,MAAM,qCAAqC,CAAC;AAC7C,OAAO,EAAE,oBAAoB,EAAE,MAAM,+CAA+C,CAAC;AAGrF,MAAM,SAAS,GAAG,oBAAoB,CAAC;AACvC,MAAM,SAAS,GAAG,oBAAoB,CAAC;AACvC,MAAM,MAAM,GAAG,wBAAwB,CAAC;AACxC,MAAM,MAAM,GAAG,wBAAwB,CAAC;AAExC,MAAM,cAAc,GAAwB;IAC1C,QAAQ,EAAE;QACR,UAAU,EAAE;YACV,IAAI,EAAE,IAAI;SACX;KACF;IACD,CAAC,EAAE;QACD,IAAI,EAAE,IAAI;KACX;CACF,CAAC;AAEF,cAAc,CAAC,GAAG,SAAS,oBAAoB,MAAM,EAAE,CAAC,GAAG;IACzD,IAAI,EAAE,IAAI;CACX,CAAC;AAEF,cAAc,CAAC,GAAG,SAAS,qBAAqB,MAAM,EAAE,CAAC,GAAG;IAC1D,IAAI,EAAE,IAAI;CACX,CAAC;AAEF,cAAc,CAAC,GAAG,SAAS,wBAAwB,MAAM,EAAE,CAAC,GAAG;IAC7D,IAAI,EAAE,IAAI;CACX,CAAC;AAEF,cAAc,CAAC,GAAG,SAAS,wBAAwB,MAAM,EAAE,CAAC,GAAG;IAC7D,IAAI,EAAE,IAAI;CACX,CAAC;AAEF,cAAc,CAAC,GAAG,SAAS,qBAAqB,MAAM,EAAE,CAAC,GAAG;IAC1D,IAAI,EAAE,IAAI;CACX,CAAC;AAEF,cAAc,CAAC,GAAG,SAAS,oBAAoB,MAAM,EAAE,CAAC,GAAG;IACzD,IAAI,EAAE,IAAI;CACX,CAAC;AAEF,cAAc,CAAC,GAAG,SAAS,wBAAwB,MAAM,EAAE,CAAC,GAAG;IAC7D,IAAI,EAAE,IAAI;CACX,CAAC;AACF,MAAM,CAAC,OAAO,OAAO,gBAAiB,SAAQ,UAAU;IAAxD;;QAIE,cAAS,GAAG,CAAC,CAAC,CAAC;QAoBP,oBAAe,GAAG,EAAE,CAAC;IAiO/B,CAAC;IA/NC,IAAI,IAAI;QACN,IAAI,IAAI,CAAC,GAAG,EAAE;YACZ,OAAO,KAAK,CAAC,IAAI,CAAC,IAAI,CAAC,GAAG,CAAC,gBAAgB,CAAC,KAAK,CAAC,CAAC;iBAChD,MAAM,CAAC,QAAQ,CAAC;iBAChB,IAAI,CAAC,YAAY,CAAC,CAAC;SACvB;QACD,OAAO,EAAE,CAAC;IACZ,CAAC;IAED,IAAI,YAAY;QACd,IAAI,IAAI,CAAC,WAAW,EAAE;YACpB,OAAO,KAAK,CAAC,IAAI,CAAC,IAAI,CAAC,WAAW,CAAC,gBAAgB,CAAC,KAAK,CAAC,CAAC;iBACxD,MAAM,CAAC,QAAQ,CAAC;iBAChB,IAAI,CAAC,YAAY,CAAC,CAAC;SACvB;QACD,OAAO,EAAE,CAAC;IACZ,CAAC;IAED,KAAK,CAAC,GAAG;QACP,IAAI,CAAC,MAAM,CAAC,IAAI,GAAG,IAAI,CAAC;IAC1B,CAAC;IAEO,QAAQ;QACd,IAAI,CAAC,WAAW,GAAG,SAAS,CAAC;QAC7B,IAAI,CAAC,kBAAkB,GAAG,SAAS,CAAC;QACpC,IAAI,CAAC,mBAAmB,GAAG,SAAS,CAAC;IACvC,CAAC;IAEO,mBAAmB,CACzB,GAAa,EACb,MAAc;QAEd,MAAM,cAAc,GAAiB,CAC5B,IAAI,CAAC,UAAW,CAAC,aAAa,CAAC,gBAAgB,MAAM,IAAI,CAAG;aAChE,QAAQ,CACZ,CAAC;QACF,MAAM,QAAQ,GAAG,cAAc,EAAE,KAAK,CAAC;QACvC,IAAI,QAAQ,EAAE;YACZ,OAAO,IAAI,CAAC,GAAG,EAAE,KAAK,EAAE,QAAQ,CAAC,IAAI,SAAS,CAAC;SAChD;QACD,OAAO,SAAS,CAAC;IACnB,CAAC;IAEO,KAAK,CAAC,eAAe,CAAC,GAAU;QACtC,MAAM,IAAI,GAA6B,GAAG,CAAC,MAAO,EAAE,KAAK,EAAE,IAAI,CAAC,CAAC,CAAC,IAAI,KAAK,CAAC;QAC5E,IAAI,CAAC,IAAI;YAAE,OAAO;QAElB,IAAI,CAAC,eAAe,GAAG,IAAI,CAAC,IAAI,CAAC;QAEjC,MAAM,YAAY,GAAG,MAAM,IAAI,CAAC,IAAI,EAAE,CAAC;QACvC,IAAI,CAAC,WAAW,GAAG,IAAI,SAAS,EAAE,CAAC,eAAe,CAChD,YAAY,EACZ,iBAAiB,CAClB,CAAC;QACF,IAAI,CAAC,cAAc,CAAC,QAAQ,GAAG,IAAI,CAAC;IACtC,CAAC;IAEO,qBAAqB;QAC3B,OAAO,IAAI,CAAA;;;;eAIA,GAAG,CAAC,6BAA6B,CAAC;eAClC,GAAG,EAAE;YACZ,IAAI,CAAC,kBAAkB,GAAG,SAAS,CAAC;YACpC,IAAI,CAAC,mBAAmB,GAAG,SAAS,CAAC;QACvC,CAAC;mBACY,CAAC;IAClB,CAAC;IAEO,mBAAmB;QACzB,OAAO,IAAI,CAAA;;;;eAIA,GAAG,CAAC,uBAAuB,CAAC;eAC5B,GAAG,EAAE;YACZ,IAAI,CAAC,kBAAkB,GAAG,IAAI,CAAC,mBAAmB,CAChD,IAAI,CAAC,GAAG,EACR,iBAAiB,CAClB,CAAC;YACF,IAAI,CAAC,mBAAmB,GAAG,IAAI,CAAC,mBAAmB,CACjD,IAAI,CAAC,WAAY,EACjB,iBAAiB,CAClB,CAAC;QACJ,CAAC;mBACY,CAAC;IAClB,CAAC;IAES,iBAAiB;QACzB,OAAO,IAAI,CAAA;;;eAGA,GAAG,CAAC,OAAO,CAAC;;mBAER,CAAC;IAClB,CAAC;IAES,aAAa;QACrB,MAAM,aAAa,GAAoB,QAAQ,CAAC,IAAI,CAAC,kBAAmB,CAAC,CAAC;QAC1E,MAAM,cAAc,GAAoB,QAAQ,CAAC,IAAI,CAAC,mBAAoB,CAAC,CAAC;QAE5E,OAAO,IAAI,CAAA;0BACW,IAAI,CAAC,kBAAmB;2BACvB,IAAI,CAAC,mBAAoB;yBAC3B,OAAO,aAAa,KAAK,QAAQ,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,aAAa;0BACrD,OAAO,cAAc,KAAK,QAAQ;YAClD,CAAC,CAAC,EAAE;YACJ,CAAC,CAAC,cAAc;4BACE,IAAI,CAAC,OAAO;6BACX,IAAI,CAAC,eAAe;0BACvB,cAAc;;QAEhC,IAAI,CAAC,qBAAqB,EAAE,IAAI,IAAI,CAAC,iBAAiB,EAAE,EAAE,CAAC;IACjE,CAAC;IAEO,aAAa,CAAC,IAAe,EAAE,EAAU;QAC/C,OAAO,IAAI,CAAA,iBAAiB,EAAE;QAC1B,IAAI,CAAC,GAAG,CAAC,GAAG,CAAC,EAAE;YACf,MAAM,IAAI,GAAG,gBAAgB,CAAC,GAAG,CAAC,CAAC;YACnC,OAAO,IAAI,CAAA,yBAAyB,QAAQ,CAAC,GAAG,CAAC;kBACvC,IAAI;yBACG,CAAC;QACpB,CAAC,CAAC;gBACQ,CAAC;IACf,CAAC;IAES,cAAc;QACtB,OAAO,IAAI,CAAA;;iBAEE,GAAG,CAAC,6BAA6B,CAAC;;cAErC,IAAI,CAAC,aAAa,CAAC,IAAI,CAAC,IAAI,EAAE,iBAAiB,CAAC;;;;iBAI7C,GAAG,CAAC,8BAA8B,CAAC;;cAEtC,IAAI,CAAC,aAAa,CAAC,IAAI,CAAC,YAAY,EAAE,iBAAiB,CAAC;;;;QAI9D,IAAI,CAAC,mBAAmB,EAAE,IAAI,IAAI,CAAC,iBAAiB,EAAE,EAAE,CAAC;IAC/D,CAAC;IAES,wBAAwB;QAChC,OAAO,IAAI,CAAA;;;;;;;oBAOK,CAAC,GAAU,EAAE,EAAE,CACvB,IAAI,CAAC,aAAa,CAAC,oBAAoB,CAAC,IAAI,CAAC,eAAe,CAAC,GAAG,CAAC,CAAC,CAAC;;;;mBAI5D,GAAG,CAAC,kCAAkC,CAAC;mBACvC,GAAG,EAAE;YACZ,MAAM,KAAK,GAA4B,CACrC,IAAI,CAAC,UAAW,CAAC,aAAa,CAAC,gBAAgB,CAAC,CACjD,CAAC;YACF,KAAK,EAAE,KAAK,EAAE,CAAC;QACjB,CAAC;;;QAGH,IAAI,CAAC,iBAAiB,EAAE,EAAE,CAAC;IACjC,CAAC;IAEO,YAAY,CAClB,OAAuB,EACvB,OAAe;QAEf,OAAO,IAAI,CAAA,wBAAwB,OAAO,aAAa,IAAI,CAAC,QAAQ;QAChE,OAAO;kBACG,CAAC;IACjB,CAAC;IAED,MAAM;QACJ,IAAI,CAAC,IAAI,CAAC,GAAG;YAAE,OAAO,IAAI,CAAA,EAAE,CAAC;QAE7B,IAAI,IAAI,CAAC,kBAAkB,IAAI,IAAI,CAAC,mBAAmB,EAAE;YACvD,OAAO,IAAI,CAAC,YAAY,CACtB,IAAI,CAAC,aAAa,EAAE,EACpB,GAAG,CAAC,yBAAyB,CAAC,CAC/B,CAAC;SACH;aAAM,IAAI,IAAI,CAAC,WAAW,EAAE;YAC3B,OAAO,IAAI,CAAC,YAAY,CACtB,IAAI,CAAC,cAAc,EAAE,EACrB,GAAG,CAAC,4BAA4B,CAAC,CAClC,CAAC;SACH;aAAM;YACL,OAAO,IAAI,CAAC,YAAY,CACtB,IAAI,CAAC,wBAAwB,EAAE,EAC/B,GAAG,CAAC,gCAAgC,CAAC,CACtC,CAAC;SACH;IACH,CAAC;;AAEM,uBAAM,GAAG,GAAG,CAAA;;;;;;;;;;;;;;;;;;;;;;GAsBlB,CAAC;AAtPF;IADC,QAAQ,CAAC,EAAE,SAAS,EAAE,KAAK,EAAE,CAAC;6CACb;AAElB;IADC,QAAQ,CAAC,EAAE,IAAI,EAAE,MAAM,EAAE,CAAC;mDACZ;AAGf;IADC,QAAQ,CAAC,EAAE,SAAS,EAAE,KAAK,EAAE,CAAC;qDACM;AAGrC;IADC,QAAQ,CAAC,EAAE,SAAS,EAAE,KAAK,EAAE,CAAC;4DACS;AAGxC;IADC,QAAQ,CAAC,EAAE,SAAS,EAAE,KAAK,EAAE,CAAC;6DACU;AAGzC;IADC,KAAK,CAAC,YAAY,CAAC;gDACJ;AAGhB;IADC,KAAK,CAAC,gBAAgB,CAAC;wDACkB;AAG1C;IADC,QAAQ,CAAC,EAAE,SAAS,EAAE,KAAK,EAAE,CAAC;iDACd","sourcesContent":["import {\n  css,\n  html,\n  LitElement,\n  property,\n  query,\n  TemplateResult,\n} from 'lit-element';\nimport { get } from 'lit-translate';\n\nimport '@material/mwc-dialog';\nimport '@material/mwc-list';\nimport '@material/mwc-list/mwc-list-item';\nimport '@material/mwc-formfield';\nimport '@material/mwc-checkbox';\n\nimport { Dialog } from '@material/mwc-dialog';\nimport { ListItemBase } from '@material/mwc-list/mwc-list-item-base';\nimport { List } from '@material/mwc-list';\n\nimport '@openscd/open-scd/src/plain-compare-list.js';\n\nimport {\n  compareNames,\n  find,\n  getNameAttribute,\n  identity,\n  isPublic,\n} from '@openscd/open-scd/src/foundation.js';\nimport { newPendingStateEvent } from '@openscd/core/foundation/deprecated/waiter.js';\nimport { DiffFilter } from '@openscd/open-scd/src/foundation/compare.js';\n\nconst tctrClass = `LN[lnClass='TCTR']`;\nconst tvtrClass = `LN[lnClass='TVTR']`;\nconst setMag = `SDI[name='setMag'] Val`;\nconst setVal = `DAI[name='setVal'] Val`;\n\nconst filterToIgnore: DiffFilter<Element> = {\n  ':scope': {\n    attributes: {\n      name: true,\n    },\n  },\n  P: {\n    full: true,\n  },\n};\n\nfilterToIgnore[`${tctrClass} DOI[name='Rat'] ${setMag}`] = {\n  full: true,\n};\n\nfilterToIgnore[`${tctrClass} DOI[name='ARtg'] ${setMag}`] = {\n  full: true,\n};\n\nfilterToIgnore[`${tctrClass} DOI[name='ARtgNom'] ${setMag}`] = {\n  full: true,\n};\n\nfilterToIgnore[`${tctrClass} DOI[name='ARtgSec'] ${setVal}`] = {\n  full: true,\n};\n\nfilterToIgnore[`${tvtrClass} DOI[name='VRtg'] ${setMag}`] = {\n  full: true,\n};\n\nfilterToIgnore[`${tvtrClass} DOI[name='Rat'] ${setMag}`] = {\n  full: true,\n};\n\nfilterToIgnore[`${tvtrClass} DOI[name='VRtgSec'] ${setVal}`] = {\n  full: true,\n};\nexport default class CompareIEDPlugin extends LitElement {\n  @property({ attribute: false })\n  doc!: XMLDocument;\n  @property({ type: Number })\n  editCount = -1;\n\n  @property({ attribute: false })\n  templateDoc: XMLDocument | undefined;\n\n  @property({ attribute: false })\n  selectedProjectIed: Element | undefined;\n\n  @property({ attribute: false })\n  selectedTemplateIed: Element | undefined;\n\n  @query('mwc-dialog')\n  dialog!: Dialog;\n\n  @query('#template-file')\n  private templateFileUI!: HTMLInputElement;\n\n  @property({ attribute: false })\n  docName!: string;\n\n  private templateDocName = '';\n\n  get ieds(): Element[] {\n    if (this.doc) {\n      return Array.from(this.doc.querySelectorAll(`IED`))\n        .filter(isPublic)\n        .sort(compareNames);\n    }\n    return [];\n  }\n\n  get templateIeds(): Element[] {\n    if (this.templateDoc) {\n      return Array.from(this.templateDoc.querySelectorAll(`IED`))\n        .filter(isPublic)\n        .sort(compareNames);\n    }\n    return [];\n  }\n\n  async run(): Promise<void> {\n    this.dialog.open = true;\n  }\n\n  private onClosed(): void {\n    this.templateDoc = undefined;\n    this.selectedProjectIed = undefined;\n    this.selectedTemplateIed = undefined;\n  }\n\n  private getSelectedListItem(\n    doc: Document,\n    listId: string\n  ): Element | undefined {\n    const selectListItem = <ListItemBase>(\n      (<List>this.shadowRoot!.querySelector(`mwc-list[id='${listId}']`)!)\n        .selected\n    );\n    const identity = selectListItem?.value;\n    if (identity) {\n      return find(doc, 'IED', identity) ?? undefined;\n    }\n    return undefined;\n  }\n\n  private async getTemplateFile(evt: Event): Promise<void> {\n    const file = (<HTMLInputElement | null>evt.target)?.files?.item(0) ?? false;\n    if (!file) return;\n\n    this.templateDocName = file.name;\n\n    const templateText = await file.text();\n    this.templateDoc = new DOMParser().parseFromString(\n      templateText,\n      'application/xml'\n    );\n    this.templateFileUI.onchange = null;\n  }\n\n  private renderSelectIedButton(): TemplateResult {\n    return html`<mwc-button\n      slot=\"primaryAction\"\n      icon=\"arrow_back\"\n      trailingIcon\n      label=\"${get('compare-ied.selectIedButton')}\"\n      @click=${() => {\n        this.selectedProjectIed = undefined;\n        this.selectedTemplateIed = undefined;\n      }}\n    ></mwc-button>`;\n  }\n\n  private renderCompareButton(): TemplateResult {\n    return html`<mwc-button\n      slot=\"primaryAction\"\n      icon=\"compare_arrows\"\n      trailingIcon\n      label=\"${get('compare.compareButton')}\"\n      @click=${() => {\n        this.selectedProjectIed = this.getSelectedListItem(\n          this.doc,\n          'currentDocument'\n        );\n        this.selectedTemplateIed = this.getSelectedListItem(\n          this.templateDoc!,\n          'currentTemplate'\n        );\n      }}\n    ></mwc-button>`;\n  }\n\n  protected renderCloseButton(): TemplateResult {\n    return html`<mwc-button\n      slot=\"secondaryAction\"\n      dialogAction=\"close\"\n      label=\"${get('close')}\"\n      style=\"--mdc-theme-primary: var(--mdc-theme-error)\"\n    ></mwc-button>`;\n  }\n\n  protected renderCompare(): TemplateResult {\n    const leftHandTitle: string | number = identity(this.selectedProjectIed!);\n    const rightHandTitle: string | number = identity(this.selectedTemplateIed!);\n\n    return html`<plain-compare-list\n        .leftHandObject=${this.selectedProjectIed!}\n        .rightHandObject=${this.selectedTemplateIed!}\n        .leftHandTitle=${typeof leftHandTitle === 'number' ? '' : leftHandTitle}\n        .rightHandTitle=${typeof rightHandTitle === 'number'\n          ? ''\n          : rightHandTitle}\n        .leftHandSubtitle=${this.docName}\n        .rightHandSubtitle=${this.templateDocName}\n        .filterToIgnore=${filterToIgnore}\n      ></plain-compare-list>\n      ${this.renderSelectIedButton()} ${this.renderCloseButton()}`;\n  }\n\n  private renderIEDList(ieds: Element[], id: string): TemplateResult {\n    return html`<mwc-list id=\"${id}\" activatable>\n      ${ieds.map(ied => {\n        const name = getNameAttribute(ied);\n        return html`<mwc-list-item value=\"${identity(ied)}\" left>\n          <span>${name}</span>\n        </mwc-list-item>`;\n      })}\n    </mwc-list>`;\n  }\n\n  protected renderIEDLists(): TemplateResult {\n    return html`<div class=\"splitContainer\">\n        <div>\n          <div>${get('compare-ied.projectIedTitle')}</div>\n          <div class=\"iedList\">\n            ${this.renderIEDList(this.ieds, 'currentDocument')}\n          </div>\n        </div>\n        <div>\n          <div>${get('compare-ied.templateIedTitle')}</div>\n          <div class=\"iedList\">\n            ${this.renderIEDList(this.templateIeds, 'currentTemplate')}\n          </div>\n        </div>\n      </div>\n      ${this.renderCompareButton()} ${this.renderCloseButton()}`;\n  }\n\n  protected renderSelectTemplateFile(): TemplateResult {\n    return html`<div>\n        <input\n          id=\"template-file\"\n          accept=\".sed,.scd,.ssd,.isd,.iid,.cid,.icd\"\n          type=\"file\"\n          hidden\n          required\n          @change=${(evt: Event) =>\n            this.dispatchEvent(newPendingStateEvent(this.getTemplateFile(evt)))}\n        />\n\n        <mwc-button\n          label=\"${get('compare-ied.selectTemplateButton')}\"\n          @click=${() => {\n            const input = <HTMLInputElement | null>(\n              this.shadowRoot!.querySelector('#template-file')\n            );\n            input?.click();\n          }}\n        ></mwc-button>\n      </div>\n      ${this.renderCloseButton()}`;\n  }\n\n  private renderDialog(\n    content: TemplateResult,\n    heading: string\n  ): TemplateResult {\n    return html`<mwc-dialog heading=\"${heading}\" @closed=${this.onClosed}>\n      ${content}\n    </mwc-dialog>`;\n  }\n\n  render(): TemplateResult {\n    if (!this.doc) return html``;\n\n    if (this.selectedProjectIed && this.selectedTemplateIed) {\n      return this.renderDialog(\n        this.renderCompare(),\n        get('compare-ied.resultTitle')\n      );\n    } else if (this.templateDoc) {\n      return this.renderDialog(\n        this.renderIEDLists(),\n        get('compare-ied.selectIedTitle')\n      );\n    } else {\n      return this.renderDialog(\n        this.renderSelectTemplateFile(),\n        get('compare-ied.selectProjectTitle')\n      );\n    }\n  }\n\n  static styles = css`\n    mwc-dialog {\n      --mdc-dialog-min-width: 64vw;\n    }\n\n    .splitContainer {\n      display: flex;\n      padding: 8px 6px 16px;\n      height: 64vh;\n    }\n\n    .iedList {\n      flex: 50%;\n      margin: 0px 6px 0px;\n      min-width: 300px;\n      height: 100%;\n      overflow-y: auto;\n    }\n\n    .resultTitle {\n      font-weight: bold;\n    }\n  `;\n}\n"]}