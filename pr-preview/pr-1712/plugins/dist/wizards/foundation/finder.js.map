{"version":3,"file":"finder.js","sourceRoot":"","sources":["../../../src/wizards/foundation/finder.ts"],"names":[],"mappings":"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","sourcesContent":["import { html, TemplateResult } from 'lit-element';\nimport { get } from 'lit-translate';\n\nimport '@openscd/open-scd/src/finder-list.js';\nimport { Directory } from '@openscd/open-scd/src/finder-list.js';\nimport { find, identity, isPublic } from '@openscd/open-scd/src/foundation.js';\n\nexport function getDisplayString(entry: string): string {\n  if (entry.startsWith('IED:')) return entry.replace(/^.*:/, '').trim();\n  if (entry.startsWith('LN0:')) return 'LLN0';\n  return entry.replace(/^.*>/, '').trim();\n}\n\nexport function getReader(\n  doc: Document,\n  getChildren: (element: Element) => Element[]\n): (path: string[]) => Promise<Directory> {\n  return async (path: string[]) => {\n    const [tagName, id] = path[path.length - 1]?.split(': ', 2);\n    const element = find(doc, tagName, id);\n\n    if (!element)\n      return { path, header: html`<p>${get('error')}</p>`, entries: [] };\n\n    return {\n      path,\n      header: undefined,\n      entries: getChildren(element).map(\n        child => `${child.tagName}: ${identity(child)}`\n      ),\n    };\n  };\n}\n\nfunction getIED(parent: Element): Element[] {\n  if (parent.tagName === 'SCL')\n    return Array.from(parent.querySelectorAll('IED')).filter(isPublic);\n\n  return [];\n}\n\nexport function iEDPicker(doc: XMLDocument): TemplateResult {\n  return html`<finder-list\n    path=\"${JSON.stringify(['SCL: '])}\"\n    .read=${getReader(doc, getIED)}\n    .getDisplayString=${getDisplayString}\n    .getTitle=${(path: string[]) => path[path.length - 1]}\n  ></finder-list>`;\n}\n\nexport function iEDsPicker(doc: XMLDocument): TemplateResult {\n  return html`<finder-list\n    multi\n    path=\"${JSON.stringify(['SCL: '])}\"\n    .read=${getReader(doc, getIED)}\n    .getDisplayString=${getDisplayString}\n    .getTitle=${(path: string[]) => path[path.length - 1]}\n  ></finder-list>`;\n}\n\nexport function getDataModelChildren(parent: Element): Element[] {\n  if (['LDevice', 'Server'].includes(parent.tagName))\n    return Array.from(parent.children).filter(\n      child =>\n        child.tagName === 'LDevice' ||\n        child.tagName === 'LN0' ||\n        child.tagName === 'LN'\n    );\n\n  const id =\n    parent.tagName === 'LN' || parent.tagName === 'LN0'\n      ? parent.getAttribute('lnType')\n      : parent.getAttribute('type');\n\n  return Array.from(\n    parent.ownerDocument.querySelectorAll(\n      `LNodeType[id=\"${id}\"] > DO, DOType[id=\"${id}\"] > SDO, DOType[id=\"${id}\"] > DA, DAType[id=\"${id}\"] > BDA`\n    )\n  );\n}\n\nexport function dataAttributePicker(server: Element): TemplateResult {\n  return html`<finder-list\n    multi\n    .paths=${[['Server: ' + identity(server)]]}\n    .read=${getReader(server.ownerDocument, getDataModelChildren)}\n    .getDisplayString=${getDisplayString}\n    .getTitle=${(path: string[]) => path[path.length - 1]}\n  ></finder-list>`;\n}\n\nexport function getSMVDataChildren(parent: Element): Element[] {\n  if (parent.tagName === 'Server')\n    return Array.from(parent.children).filter(\n      child =>\n        child.tagName === 'LDevice' &&\n        child.querySelector('LN[lnClass=\"TCTR\"],LN[lnClass=\"TVTR\"]')\n    );\n\n  if (parent.tagName === 'LDevice')\n    return Array.from(parent.children).filter(\n      child =>\n        child.tagName === 'LN' &&\n        (child.getAttribute('lnClass') === 'TCTR' ||\n          child.getAttribute('lnClass') === 'TVTR')\n    );\n\n  const id =\n    parent.tagName === 'LN' || parent.tagName === 'LN0'\n      ? parent.getAttribute('lnType')\n      : parent.getAttribute('type');\n  const dataType = parent.ownerDocument.querySelector(\n    `LNodeType[id=\"${id}\"], DOType[id=\"${id}\"], DAType[id=\"${id}\"]`\n  );\n\n  if (!dataType) return [];\n\n  if (dataType?.tagName === 'LNodeType') {\n    return Array.from(dataType.querySelectorAll('DO') ?? []).filter(dO =>\n      dO.ownerDocument.querySelector(\n        `DOType[id=\"${dO.getAttribute('type')}\"][cdc=\"SAV\"]`\n      )\n    );\n  }\n\n  if (dataType?.tagName === 'DOType') {\n    return Array.from(dataType.querySelectorAll('DA') ?? []).filter(\n      dA =>\n        dA.getAttribute('name') === 'instMag' || dA.getAttribute('name') === 'q'\n    );\n  }\n\n  return Array.from(\n    parent.ownerDocument.querySelectorAll(\n      `LNodeType[id=\"${id}\"] > DO, DOType[id=\"${id}\"] > SDO, DOType[id=\"${id}\"] > DA, DAType[id=\"${id}\"] > BDA`\n    )\n  );\n}\n\nexport function sampledValueDataPicker(server: Element): TemplateResult {\n  return html`<finder-list\n    multi\n    paths=${JSON.stringify([['Server: ' + identity(server)]])}\n    .read=${getReader(server.ownerDocument, getSMVDataChildren)}\n    .getDisplayString=${getDisplayString}\n    .getTitle=${(path: string[]) => path[path.length - 1]}\n  ></finder-list>`;\n}\n"]}